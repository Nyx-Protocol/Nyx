# docs/deployment/rollback.md

> **遵守バッジ** : :no_entry: 実装コード非出力 / :no_entry_sign: C/C++依存禁止

## 目次
- [目的](#目的)
- [失敗検知](#失敗検知)
- [判断基準](#判断基準)
- [ロールバック手順](#ロールバック手順)
- [データ整合性確保](#データ整合性確保)
- [コミュニケーション手順](#コミュニケーション手順)
- [事後レビュー](#事後レビュー)
- [関連ドキュメント](#関連ドキュメント)

## 目的
デプロイ失敗時の迅速かつ安全な復旧手順を定義し、サービス可用性とデータ整合性を守る。

## 失敗検知
- **自動アラート**: SLO逸脱、匿名性指数低下、エラーレート上昇。
- **手動報告**: オンコール、CSチーム。
- 監視基盤は[testing/metrics.md](../testing/metrics.md)を参照。

## 判断基準
| 条件 | ロールバック判断 |
|------|------------------|
| Criticalインシデント | 即時ロールバック |
| Highインシデント | 15分以内に改善なければロールバック |
| Medium/Low | 代替策有りなら継続 |

## ロールバック手順
1. **停止**: デプロイパイプラインを停止。
2. **評価**: 影響範囲、データ状態をレビュー。
3. **切替**: Blue/Greenの場合は前バージョンへスイッチ。Canaryの場合はトラフィックを旧バージョンへ戻す。
4. **検証**: 主要SLIを確認。
5. **解除**: 監視状態へ戻す。

## データ整合性確保
- トランザクションを一時停止、再試行キューを利用。
- データマイグレーションはロールバック対応スクリプトを準備（C/C++非依存）。
- 監査ログは改ざん不可ストレージで保護。

## コミュニケーション手順
- インシデントチャンネルで状況共有。
- 利害関係者へ定期更新 (15分間隔)。
- 顧客への外部通知テンプレを事前準備。

## 事後レビュー
- [notes/meeting-notes.md](../notes/meeting-notes.md)テンプレでポストモーテムを実施。
- [notes/decision-log.md](../notes/decision-log.md)で対策記録。
- 改善プランを[roadmap.md](../roadmap.md)へ反映。

## 関連ドキュメント
- [deployment/ci-cd.md](./ci-cd.md)
- [deployment/infrastructure.md](./infrastructure.md)
- [testing/e2e-tests.md](../testing/e2e-tests.md)

> **宣言**: 実装コード無し、C/C++依存無し。