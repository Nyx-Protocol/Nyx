# docs/security/vulnerability.md

> **遵守バッジ** : :no_entry: 実装コード非出力 / :no_entry_sign: C/C++依存禁止

## 目次
- [目的](#目的)
- [脅威モデル (STRIDE)](#脅威モデル-stride)
- [リスク評価](#リスク評価)
- [脆弱性対策](#脆弱性対策)
- [入力検証と出力エスケープ](#入力検証と出力エスケープ)
- [サプライチェーン対策](#サプライチェーン対策)
- [監査と法的遵守](#監査と法的遵守)
- [インシデント対応](#インシデント対応)
- [セキュリティテスト対応表](#セキュリティテスト対応表)
- [関連ドキュメント](#関連ドキュメント)

## 目的
Nyxプラットフォームの脅威分析と対策方針を定義し、継続的なセキュリティ強化の基盤を提供する。

## 脅威モデル (STRIDE)
| STRIDEカテゴリ | シナリオ | 対応策 |
|----------------|----------|--------|
| Spoofing | ノード偽装、APIキー盗用 | mTLS, Device ID, Rate Limiting |
| Tampering | ルート改ざん、ログ改ざん | 署名付きイベント、WORMストレージ |
| Repudiation | 操作否認 | 監査ログハッシュ、RBAC/ABAC |
| Information Disclosure | メタデータ漏洩 | カバー交通、暗号化、情報最小化 |
| Denial of Service | セッションフラッディング | カナリアリリース、Autoscale、Rate Limit |
| Elevation of Privilege | RBAC突破 | 最小権限、行動分析、MFA |

## リスク評価
| リスクID | 説明 | 可能性 | 影響 | 優先度 | 対応 |
|----------|------|--------|------|--------|------|
| RISK-001 | PQ暗号実装の未知の脆弱性 | 中 | 高 | 高 | 二重鍵交換、緊急切替手順 |
| RISK-002 | 観測者によるトラフィック相関 | 中 | 中 | 中 | タイミング撹乱、ルート再計算 |
| RISK-003 | ノード乗っ取り | 低 | 高 | 中 | ゼロトラスト監査、自動隔離 |
| RISK-004 | 外部依存のサプライチェーン攻撃 | 低 | 高 | 中 | SBOM監査、署名検証 |

## 脆弱性対策
- **CSRF**: REST APIはSameSite=strictなトークン。UIはDouble Submit Cookie。
- **XSS**: 出力エスケープ、Content Security Policy、HTMLテンプレート安全化。
- **SQLi**: パラメトリッククエリ、ORMを使用しC/C++依存を避ける。
- **クリックジャッキング**: X-Frame-Options `DENY`、CSP frame-ancestors。
- **DOS**: Rate Limit、バックプレッシャ、Auto Scaling。

## 入力検証と出力エスケープ
- JSON/XML入力はJSON Schema/Relax NGで検証。
- テキスト入力はホワイトリストベース、正規化後に検証。
- 出力エスケープ: HTML, JS, URL, CSSコンテキストごとに分離。

## サプライチェーン対策
- SBOM (SPDX)を生成し、依存は署名検証。
- サードパーティライブラリはC/C++依存なしを確認。
- 依存アップデートは四半期ごとにレビュー。

## 監査と法的遵守
- **GDPR/CCPA**: データ主体権利行使フローを提供。
- **ISO 27001**: ISMS統合を目標。
- **ロケーション**: データ越境に関する法的制約を[deployment/infrastructure.md](../deployment/infrastructure.md)で管理。

## インシデント対応
1. 検知: 監視システムからアラート。
2. 分類: 重大度 (Critical/High/Medium/Low) を判定。
3. 封じ込め: 影響範囲を隔離。
4. 根本原因分析: [notes/meeting-notes.md](../notes/meeting-notes.md)テンプレ使用。
5. 教訓反映: ADRに記録、テスト更新。

## セキュリティテスト対応表
| テストタイプ | 頻度 | 範囲 | トレーサビリティ |
|--------------|------|------|------------------|
| 静的解析 | CIごと | 暗号/入力処理 | REQ-FUN-040, REQ-NFR-020 |
| 動的解析 | 月次 | 認証/ルート | [testing/integration-tests.md](../testing/integration-tests.md) |
| ペネトレーション | 半期 | 全体 | RISK-001〜004 |
| Bug Bounty | 常時 | 公開面 | レポートはSecurity Council review |

## 関連ドキュメント
- [security/auth.md](./auth.md)
- [security/encryption.md](./encryption.md)
- [architecture/dataflow.md](../architecture/dataflow.md)
- [testing/metrics.md](../testing/metrics.md)

> **宣言**: 実装コード無し、C/C++依存無し。