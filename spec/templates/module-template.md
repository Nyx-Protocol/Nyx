# docs/templates/module-template.md

> **遵守バッジ** : :no_entry: 実装コード非出力 / :no_entry_sign: C/C++依存禁止

## 目次
- [docs/templates/module-template.md](#docstemplatesmodule-templatemd)
  - [目次](#目次)
  - [概要](#概要)
  - [目的と背景](#目的と背景)
  - [責務](#責務)
  - [境界と前提](#境界と前提)
  - [公開インターフェース](#公開インターフェース)
  - [データモデル](#データモデル)
  - [エラーハンドリング](#エラーハンドリング)
  - [メトリクスとログ](#メトリクスとログ)
  - [品質基準](#品質基準)
  - [依存関係](#依存関係)
  - [非機能要件](#非機能要件)
  - [リスクと対策](#リスクと対策)
  - [トレーサビリティ](#トレーサビリティ)
  - [更新履歴メモ](#更新履歴メモ)

## 概要
- モジュール名: 
  - 正式名称と略称の双方を記載し、アーキテクチャ図で使用される表記と一致させる。
- バージョン:
  - 契約互換性レベル (MAJOR.MINOR.PATCH) を明示し、互換性破壊を伴う場合はADR番号を添える。
- 対象フェーズ: (例: Phase γ)
  - [docs/roadmap.md](../roadmap.md) のフェーズと紐付け、導入タイムラインを記す。
  - 廃止予定の場合は Sunset 日付と移行先モジュールを併記。

> **ヒント**: 5行程度でモジュールの存在意義を要約し、ステークホルダーが概要のみで役割を想起できる記述にする。

## 目的と背景
- 課題:
  - 現行システムの制約やスケール限界、運用課題などを列挙し、優先度を付与する。
- 期待する成果:
  - 定量指標 (例: P95遅延 20%改善、運用コスト 15%削減) と非定量価値を併記。
- 関連要件: REQ-XXX
  - [docs/requirements.md](../requirements.md) から複数の要件IDをリンクし、優先度/成熟度 (Proposed, Accepted, Live) を記載。
- 参考調査:
  - 既存PoCや学術リファレンス、規制要件の引用元を列挙。

> **記載指針**: 背景セクションはステークホルダーへの説得資料となるため、課題・期待成果・トレードオフを三段構成で整理する。

## 責務
- Primary:
  - モジュールが提供する中心的な機能やユースケースを箇条書きで3点以内に要約。
- Secondary:
  - 付随的に担う補助機能を記載し、他モジュールと重複しないよう境界を示す。
- アンチパターン:
  - 避けるべき振る舞いや、境界逸脱、責務過剰となる例を具体的に記す。
- 成功指標:
  - 責務が果たされた状態を測るKPI/SLIを整理し、[testing/metrics.md](../testing/metrics.md)と連携。

## 境界と前提
- 他モジュールからの入力/出力:
  - 入力データ源、出力先、更新頻度、通信方式 (同期/非同期) を表形式で記載。
- ガードルール:
  - セキュリティ境界、データマスキング、スロットリングなど運用上の守るべきルールを列挙。
- 前提条件:
  - インフラ依存、鍵管理、必要な外部サービスなど稼働条件を明記。
- 既知の制約:
  - パフォーマンス上限や法規制依存など、設計判断に影響する制約を記す。

## 公開インターフェース
```
Interface: <名前>
  説明:
    - 呼び出し意図や利用シナリオを1文で要約。
  Inputs:
    - 項目名 / 型表現 / バリデーション規則 / 必須可否
  Outputs:
    - フィールド名 / 意味 / 匿名性への影響
  Contracts:
    - バージョン互換性、冪等性ルール、整合性保証 (例: Exactly-once)
  エラーコード:
    - コード / 解釈 / リカバリ手順
  タイムアウト:
    - クライアント側 / サーバ側推奨値
  レート制限:
    - 上限値 / バースト許容量 / 適用対象 (IP, 秘密鍵など)
  監査要求:
    - ログ化必須イベント、マスキングルール
```
(詳細仕様は[architecture/interfaces.md](../architecture/interfaces.md)参照。変化点はADRを通して周知し、互換性維持期間を明記すること。)

## データモデル
```
Record: <名前>
  目的:
    - エンティティの役割やライフサイクルを記述。
  フィールド:
    - 名前 / データ型 (抽象的表現) / 必須可否 / デフォルト / 値域
  制約:
    - 一意制約、外部参照、バージョン互換要件
  機密区分:
    - Public / Internal / Restricted / Secret
  監査属性:
    - 変更履歴、削除ポリシー、保持期間
```
> **注意**: データモデルは匿名性保護の観点から最小権限で設計し、個人情報や秘匿情報はトークナイズや匿名化を前提とする。

## エラーハンドリング
- 重大度分類:
  - Critical/High/Medium/Low の基準を定義し、例を添える。
- 再試行ポリシー:
  - 冪等性の可否、待機時間、最大試行回数、ジャitter有無。
- フォールバック:
  - Graceful degradation、キューイング、代替経路など継続運用の手段。
- 通知プロトコル:
  - オンコール、モニタリングアラート、ユーザ通知の要否。

## メトリクスとログ
| 指標ID | 説明 | 種別 (KPI/SLI/SLO) | 目標値 | 測定頻度 | 可視化場所 |
|--------|------|--------------------|--------|----------|-------------|
|        |      |                    |        |          |             |

- ログフォーマット:
  - 構造化ログのキー/値、マスキング対象、タイムスタンプ形式。
- 類似メトリクス:
  - 既存メトリクスとの重複や差異を説明し、廃止・統合計画を示す。
- 可観測性要件:
  - トレーススパン名、タグ、サンプリングレートなどを指定し、[performance/benchmark.md](../performance/benchmark.md)との整合を取る。

## 品質基準
- テスト: 単体/統合/E2E (要件リンク)
  - テストIDと対象シナリオ、合格基準、必要なフィクスチャ。
- コードレビュー観点:
  - セキュリティ、性能、アクセシビリティ、国際化、運用性など確認観点をチェックリスト化。
- セキュリティ: STRIDE評価結果
  - 脅威残留リスク、緩和策、レビュー日付を記載。
- ドキュメント完備条件:
  - リリース前に更新すべき関連文書 (例: API仕様、SDKガイド) を列挙。

## 依存関係
- 入力依存:
  - 参照モジュール、契約バージョン、フェイルセーフ条件。
- 出力依存:
  - 依存先、SLA/SLO、通知義務。
- 禁止依存:
  - [architecture/dependencies.md](../architecture/dependencies.md) の層別ルールに基づく禁止事項。
- 将来の依存計画:
  - ロードマップ上で検討中の追加依存や削除予定を記載。

## 非機能要件
- パフォーマンス:
  - レイテンシ、スループット、メモリ/CPU上限など定量目標。
- 可用性:
  - Uptime、フェイルオーバ戦略、RTO/RPO。
- アクセシビリティ (該当する場合):
  - UI/CLI/APIが満たすべきアクセシビリティ要件や多言語対応方針。
- 運用性:
  - 監視、アラート、日次/週次オペレーションタスク。
- コンプライアンス:
  - GDPR、各国規制、業界標準への適合状況。

## リスクと対策
| リスクID | リスク内容 | 発生確率 | 影響度 | 緩和策 | 監視指標 |
|----------|------------|----------|--------|--------|----------|
|          |            |          |        |        |          |

- 残留リスク: 対策後も残るリスクを記載し、受容/移転/回避の判断を明確化。
- エスカレーション基準: インシデント対応の連絡フローとタイムライン。

## トレーサビリティ
- 要件: [requirements.md](../requirements.md)
- テスト: [templates/test-template.md](./test-template.md)
- ADR: [notes/decision-log.md](../notes/decision-log.md)
- コードリポジトリ: 対応するディレクトリ/サービス名、既存タグ。
- モニタリング: 関連ダッシュボード、アラートポリシー、運用Runbookへのリンク。

## 更新履歴メモ
- YYYY-MM-DD: 著者 / 変更概要 (例: 初版作成、責務セクション拡充)。
- YYYY-MM-DD: 著者 / インターフェース定義追記。

> **宣言**: 実装コード無し、C/C++依存無し。テンプレートを編集する際も本方針を厳守すること。