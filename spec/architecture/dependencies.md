# docs/architecture/dependencies.md

> **遵守バッジ** : :no_entry: 実装コード非出力 / :no_entry_sign: C/C++依存禁止

## 目次
- [目的](#目的)
- [依存関係グラフ](#依存関係グラフ)
- [層別依存ルール](#層別依存ルール)
- [循環防止ポリシー](#循環防止ポリシー)
- [バージョン管理指針](#バージョン管理指針)
- [変更管理プロセス](#変更管理プロセス)
- [違反検出と対応](#違反検出と対応)
- [関連ドキュメント](#関連ドキュメント)

## 目的
Nyxシステムにおけるモジュール依存関係を明示し、循環や層越えを防止するためのルールとプロセスを定義する。

## 依存関係グラフ
```
+-------------------+      +--------------------+
|   Client SDKs     | ---> | Secure Stream Core |
+-------------------+      +--------------------+
                                 |
                                 v
                         +----------------+
                         | Mix Routing    |
                         +----------------+
                                 |
                                 v
                         +--------------------+
                         | Obfuscation & FEC |
                         +--------------------+
                                 |
                                 v
                         +----------------+
                         | Transport I/F  |
                         +----------------+
                                 |
                                 v
                         +----------------------+
                         | Infrastructure Layer |
                         +----------------------+
```
- Observability/Control Planeは全層に横断依存を持つが、逆依存は許容しない。

## 層別依存ルール
| 層 | 許可された依存 | 禁止事項 |
|----|----------------|----------|
| クライアント | セキュアストリームAPI, SDKユーティリティ | サーバ内部DBへの直接アクセス |
| Secure Stream | Mix Routing, Control Plane | クライアントUIコンポーネント |
| Mix Routing | Obfuscation, Directory Service | Secure Stream以外のクライアント|
| Obfuscation/FEC | Transport, Observability | Mix Routing以外からの設定注入 |
| Transport | インフラ抽象、暗号ハンドラー | クライアントSDK |
| Control Plane | 全層へポリシー配信 | 下位依存からの直接呼び出し |

## 循環防止ポリシー
- モジュール化はDAG (有向非循環グラフ) を保つこと。
- 新規依存を追加する際は [templates/module-template.md](../templates/module-template.md) に事前記入し、ADR承認を得る。
- CIで依存グラフ検査を実行し、違反時はビルドを停止。

## バージョン管理指針
- 共有契約は`/contracts/<module>/<version>/`で管理。
- MAJOR更新は影響モジュールの同期更新を義務化。
- マイクロサービス間通信は後方互換で3サイクル保持。

## 変更管理プロセス
1. 変更提案: Issue/ADRで依存追加理由を説明。
2. 影響分析: [requirements.md](../requirements.md)からトレーサビリティを確認。
3. 承認: アーキテクトレビューを経て `dependency-approval` ラベル付与。
4. 実装: ドキュメント更新 → テスト更新 → コード更新の順。
5. 検証: [testing/integration-tests.md](../testing/integration-tests.md)に従い契約テスト実施。

## 違反検出と対応
- **検出手段**: 静的解析、契約テスト、CIゲート。
- **対応手順**: 直近のリリースに遡ってロールバック、[deployment/rollback.md](../deployment/rollback.md)を参照。
- **報告**: [notes/decision-log.md](../notes/decision-log.md)に記録。

## 拡張補遺: 依存リスク診断レジスタ

依存管理の成熟度を高めるため、ここではNyxアーキテクチャ上で発生し得る依存リスクを50ケース定義し、監査観点と是正策を標準化する。各ケースはシグナル、参照層、依存タイプ、兆候、重大度、SLI、検出方法、影響領域、対策、検証、フォローアップの11要素で構成され、CI/CD・運用レビューの双方で利用できるテンプレートとなる。

#### ケース DEP-001: Secure Stream→Mixループ依存兆候
- **シグナル DEP-001-01**: 静的解析でSecure StreamがMixの内部構造へアクセス。
- **参照層 DEP-001-02**: Secure Stream (上位) → Mix (下位)。
- **依存タイプ DEP-001-03**: コード参照。
- **兆候 DEP-001-04**: `mix/internal`名前空間へのimportが検出。
- **重大度 DEP-001-05**: High。
- **SLI DEP-001-06**: CI依存検査失敗率。
- **検出 DEP-001-07**: `cargo deny`カスタムルール。
- **影響 DEP-001-08**: 層境界崩壊による循環リスク。
- **対策 DEP-001-09**: 公開インターフェースで抽象化し、内部モジュールは禁止。
- **検証 DEP-001-10**: 依存グラフDiffレビュー。
- **フォロー DEP-001-11**: `notes/decision-log.md`へ是正記録。

#### ケース DEP-002: Mix→Secure Stream逆依存の増殖
- **シグナル DEP-002-01**: Mix層がSecure Stream APIへ直接依存。
- **参照層 DEP-002-02**: Mix (上位禁止) → Secure Stream。
- **依存タイプ DEP-002-03**: ランタイム呼び出し。
- **兆候 DEP-002-04**: `RoutePlanner`がStreamセッション管理を参照。
- **重大度 DEP-002-05**: Critical。
- **SLI DEP-002-06**: 逆依存検出件数。
- **検出 DEP-002-07**: ArchUnit風テストをRustへ移植した`arch-tests`。
- **影響 DEP-002-08**: 循環と拡張阻害。
- **対策 DEP-002-09**: イベント駆動の非同期通知にリファクタ。
- **検証 DEP-002-10**: `testing/integration-tests.md`に逆依存抑止テスト追加。
- **フォロー DEP-002-11**: ADRで構造決定を追記。

#### ケース DEP-003: ObfuscationとTransportのバイパス依存
- **シグナル DEP-003-01**: ObfuscationがTransport内部ソケット実装を参照。
- **参照層 DEP-003-02**: Obfuscation → Transport内部。
- **依存タイプ DEP-003-03**: 実装密結合。
- **兆候 DEP-003-04**: `transport::socket::raw`モジュール使用。
- **重大度 DEP-003-05**: High。
- **SLI DEP-003-06**: ビルド時許容されない。
- **検出 DEP-003-07**: 依存ホワイトリストで検知。
- **影響 DEP-003-08**: Transport交換困難。
- **対策 DEP-003-09**: ポート&アダプタ経由に統一。
- **検証 DEP-003-10**: コントラクトテストで間接化確認。
- **フォロー DEP-003-11**: 設計レビュー。

#### ケース DEP-004: Control Planeからの逆注入
- **シグナル DEP-004-01**: 下位層がControl Planeを直接コール。
- **参照層 DEP-004-02**: Transport→Control。
- **依存タイプ DEP-004-03**: API誤使用。
- **兆候 DEP-004-04**: Transportがポリシークエリを同期実行。
- **重大度 DEP-004-05**: Medium。
- **SLI DEP-004-06**: 同期呼び出し頻度。
- **検出 DEP-004-07**: メトリクスで同期呼び出しを捕捉。
- **影響 DEP-004-08**: ポリシー反映遅延。
- **対策 DEP-004-09**: Pub/Sub通知へ置換。
- **検証 DEP-004-10**: リグレッションテスト。
- **フォロー DEP-004-11**: `docs/configuration.md`更新。

#### ケース DEP-005: SDKからインフラ層への直結
- **シグナル DEP-005-01**: SDKがインフラAPIへ直接接続。
- **参照層 DEP-005-02**: クライアント→インフラ。
- **依存タイプ DEP-005-03**: ネットワーク呼び出し。
- **兆候 DEP-005-04**: SDK内にVPCエンドポイント。
- **重大度 DEP-005-05**: Critical。
- **SLI DEP-005-06**: 直結検知率。
- **検出 DEP-005-07**: 静的コードスキャン。
- **影響 DEP-005-08**: セキュリティ境界破壊。
- **対策 DEP-005-09**: Stream API経由に制限。
- **検証 DEP-005-10**: SDK依存CI。
- **フォロー DEP-005-11**: SDKリリースノート。

#### ケース DEP-006: 外部ライブラリのバージョン逸脱
- **シグナル DEP-006-01**: 共有ライブラリのバージョンスキュー。
- **参照層 DEP-006-02**: 全層共通。
- **依存タイプ DEP-006-03**: パッケージ管理。
- **兆候 DEP-006-04**: `Cargo.lock`差分で異なるマイナーバージョン。
- **重大度 DEP-006-05**: Medium。
- **SLI DEP-006-06**: バージョン整合率。
- **検出 DEP-006-07**: `cargo tree -d`。
- **影響 DEP-006-08**: 予期しないAPI差異。
- **対策 DEP-006-09**: ワークスペースで統一。
- **検証 DEP-006-10**: 互換テスト。
- **フォロー DEP-006-11**: `CHANGELOG.md`記述。

#### ケース DEP-007: テストコードから本番コードへの逆依存
- **シグナル DEP-007-01**: テストモジュールが本番コードへ公開すべきでないヘルパを追加。
- **参照層 DEP-007-02**: tests→src内部。
- **依存タイプ DEP-007-03**: コンパイル依存。
- **兆候 DEP-007-04**: `#[cfg(test)]`で公開関数。
- **重大度 DEP-007-05**: Low。
- **SLI DEP-007-06**: テスト公開API数。
- **検出 DEP-007-07**: Lint。
- **影響 DEP-007-08**: API漏出。
- **対策 DEP-007-09**: Feature Gateで隔離。
- **検証 DEP-007-10**: Lint結果レビュー。
- **フォロー DEP-007-11**: コーディング規約更新。

#### ケース DEP-008: Obfuscation→Observability循環
- **シグナル DEP-008-01**: ObfuscationがObservability内部依存へアクセス。
- **参照層 DEP-008-02**: 横断依存。
- **依存タイプ DEP-008-03**: ライブラリリンク。
- **兆候 DEP-008-04**: オブフ層からTelemetry実装直接参照。
- **重大度 DEP-008-05**: Medium。
- **SLI DEP-008-06**: 循環検知数。
- **検出 DEP-008-07**: グラフ解析ツール。
- **影響 DEP-008-08**: ビルドオーダ複雑化。
- **対策 DEP-008-09**: インターフェース経由に変更。
- **検証 DEP-008-10**: モック差替テスト。
- **フォロー DEP-008-11**: テレメトリ契約追記。

#### ケース DEP-009: Transport→Infrastructure以外の直参照
- **シグナル DEP-009-01**: Transportがインフラ以外の外部サービスへ直接アクセス。
- **参照層 DEP-009-02**: Transport→外部API。
- **依存タイプ DEP-009-03**: ネットワーク。
- **兆候 DEP-009-04**: Transport内から外部REST呼び出し。
- **重大度 DEP-009-05**: High。
- **SLI DEP-009-06**: 直参照数。
- **検出 DEP-009-07**: 静的依存リスト。
- **影響 DEP-009-08**: パフォーマンス悪化。
- **対策 DEP-009-09**: Control経由で仲介。
- **検証 DEP-009-10**: パフォーマンステスト。
- **フォロー DEP-009-11**: ADR更新。

#### ケース DEP-010: CLIツールとDaemonの依存競合
- **シグナル DEP-010-01**: CLIとDaemonが異なるAPIバージョン利用。
- **参照層 DEP-010-02**: nyx-cli ↔ nyx-daemon。
- **依存タイプ DEP-010-03**: ライブラリ。
- **兆候 DEP-010-04**: `Cargo.lock`差分でAPI v1/v2混在。
- **重大度 DEP-010-05**: Medium。
- **SLI DEP-010-06**: 競合数。
- **検出 DEP-010-07**: 依存レポート。
- **影響 DEP-010-08**: CLI互換性崩壊。
- **対策 DEP-010-09**: 共通クレートに統合。
- **検証 DEP-010-10**: CLI回帰試験。
- **フォロー DEP-010-11**: リリースチェックリスト更新。

#### ケース DEP-011: SDK→Telemetry直接書き込み
- **シグナル DEP-011-01**: SDKがTelemetryバックエンドへ直接送信。
- **参照層 DEP-011-02**: クライアント→Observability。
- **依存タイプ DEP-011-03**: ネットワーク。
- **兆候 DEP-011-04**: モバイルSDKでGrafanaエンドポイント利用。
- **重大度 DEP-011-05**: High。
- **SLI DEP-011-06**: 直接書き込み数。
- **検出 DEP-011-07**: 静的分析。
- **影響 DEP-011-08**: 観測基盤への不正アクセス。
- **対策 DEP-011-09**: Control経由のプロキシ適用。
- **検証 DEP-011-10**: SDKテスト。
- **フォロー DEP-011-11**: SDKガイド更新。

#### ケース DEP-012: Observability→Secure Stream実装依存
- **シグナル DEP-012-01**: 観測層がStream内部構造へ依存。
- **参照層 DEP-012-02**: Observability→Secure Stream内部。
- **依存タイプ DEP-012-03**: ダイレクトリンク。
- **兆候 DEP-012-04**: Telemetryが内部ロックを参照。
- **重大度 DEP-012-05**: Medium。
- **SLI DEP-012-06**: 内部型参照数。
- **検出 DEP-012-07**: 型可視性チェック。
- **影響 DEP-012-08**: リファクタ耐性低下。
- **対策 DEP-012-09**: 公開イベント経由に変更。
- **検証 DEP-012-10**: 型境界テスト。
- **フォロー DEP-012-11**: API契約更新。

#### ケース DEP-013: Control Plane内部の循環設定
- **シグナル DEP-013-01**: ポリシーが互いに依存。
- **参照層 DEP-013-02**: Control内部。
- **依存タイプ DEP-013-03**: 設定グラフ。
- **兆候 DEP-013-04**: IaCグラフ解析で循環。
- **重大度 DEP-013-05**: High。
- **SLI DEP-013-06**: 循環検出件数。
- **検出 DEP-013-07**: `docs/architecture/dependencies.md`記述ガイドに基づくCI。
- **影響 DEP-013-08**: 設定適用停止。
- **対策 DEP-013-09**: 依存分割。
- **検証 DEP-013-10**: IaCテスト。
- **フォロー DEP-013-11**: `docs/specs.md`へ反映。

#### ケース DEP-014: Mix→Observabilityへの重複ログ依存
- **シグナル DEP-014-01**: Mix層が複数ログライブラリへ依存。
- **参照層 DEP-014-02**: Mix。
- **依存タイプ DEP-014-03**: ロギング。
- **兆候 DEP-014-04**: `log4rs`と`tracing`同時使用。
- **重大度 DEP-014-05**: Low。
- **SLI DEP-014-06**: ログ依存数。
- **検出 DEP-014-07**: Cargo依存解析。
- **影響 DEP-014-08**: バイナリサイズ増。
- **対策 DEP-014-09**: ログ抽象層一本化。
- **検証 DEP-014-10**: ログ出力テスト。
- **フォロー DEP-014-11**: コーディング規約追記。

#### ケース DEP-015: Obfuscation→Control双方向イベント
- **シグナル DEP-015-01**: 双方向イベントで循環遅延。
- **参照層 DEP-015-02**: Obfuscation↔Control。
- **依存タイプ DEP-015-03**: イベント連鎖。
- **兆候 DEP-015-04**: 互いのイベントを即時再送。
- **重大度 DEP-015-05**: Medium。
- **SLI DEP-015-06**: ループ検知数。
- **検出 DEP-015-07**: Telemetryでイベント頻度検出。
- **影響 DEP-015-08**: 制御振動。
- **対策 DEP-015-09**: ワンウェイコマンドへ変更。
- **検証 DEP-015-10**: ループテスト。
- **フォロー DEP-015-11**: Runbook。

#### ケース DEP-016: Transport→FEC実装漏れ
- **シグナル DEP-016-01**: TransportがFEC設定を参照し忘れ。
- **参照層 DEP-016-02**: Transport→Obfuscation。
- **依存タイプ DEP-016-03**: 設定冗長。
- **兆候 DEP-016-04**: FEC未適用セッション。
- **重大度 DEP-016-05**: High。
- **SLI DEP-016-06**: FEC適用率。
- **検出 DEP-016-07**: Telemetryチェック。
- **影響 DEP-016-08**: ロス増。
- **対策 DEP-016-09**: 設定Contractで強制。
- **検証 DEP-016-10**: E2E検証。
- **フォロー DEP-016-11**: `nyx-fec`文書更新。

#### ケース DEP-017: Secure Stream→Infrastructure直接認証
- **シグナル DEP-017-01**: Secure Streamがインフラ認証基盤へ直アクセス。
- **参照層 DEP-017-02**: Secure Stream→Infra。
- **依存タイプ DEP-017-03**: 認証API。
- **兆候 DEP-017-04**: HSM API呼び出しが直接実装。
- **重大度 DEP-017-05**: High。
- **SLI DEP-017-06**: 直接呼び出し件数。
- **検出 DEP-017-07**: コード検索。
- **影響 DEP-017-08**: セキュリティ境界侵害。
- **対策 DEP-017-09**: ControlまたはKeyサービス経由。
- **検証 DEP-017-10**: セキュリティレビュー。
- **フォロー DEP-017-11**: ADR追記。

#### ケース DEP-018: CLI→UIテンプレート依存
- **シグナル DEP-018-01**: CLIがUIテンプレートに依存。
- **参照層 DEP-018-02**: CLI→docs/templates。
- **依存タイプ DEP-018-03**: ビルドリソース。
- **兆候 DEP-018-04**: CLIビルド時にUIテンプレート読み込み。
- **重大度 DEP-018-05**: Low。
- **SLI DEP-018-06**: 不要依存数。
- **検出 DEP-018-07**: ビルドログ。
- **影響 DEP-018-08**: デプロイアーティファクト肥大。
- **対策 DEP-018-09**: テンプレートをdocsへ限定。
- **検証 DEP-018-10**: ビルド再実行。
- **フォロー DEP-018-11**: 依存リスト更新。

#### ケース DEP-019: テストフレームワークの多重採用
- **シグナル DEP-019-01**: 同一クレートで複数テストランナー依存。
- **参照層 DEP-019-02**: 全層。
- **依存タイプ DEP-019-03**: テストライブラリ。
- **兆候 DEP-019-04**: `proptest`と`quickcheck`同居。
- **重大度 DEP-019-05**: Low。
- **SLI DEP-019-06**: テスト依存数。
- **検出 DEP-019-07**: Cargo解析。
- **影響 DEP-019-08**: ビルド時間増。
- **対策 DEP-019-09**: テスト戦略統一。
- **検証 DEP-019-10**: テストCI実行。
- **フォロー DEP-019-11**: コントリビュートガイド改訂。

#### ケース DEP-020: Observability→Complianceデータ共有
- **シグナル DEP-020-01**: 観測データがComplianceストアへ直接コピー。
- **参照層 DEP-020-02**: Observability→Compliance。
- **依存タイプ DEP-020-03**: データ複製。
- **兆候 DEP-020-04**: Telemetry ExportがComplianceバケットへ書込。
- **重大度 DEP-020-05**: Medium。
- **SLI DEP-020-06**: 直接書込件数。
- **検出 DEP-020-07**: ストレージアクセスログ。
- **影響 DEP-020-08**: データ整合性不整合。
- **対策 DEP-020-09**: Control経由のETLへ統一。
- **検証 DEP-020-10**: データラインテスト。
- **フォロー DEP-020-11**: 監査レポート更新。

#### ケース DEP-021: Mix→Telemetryに同期書き込み
- **シグナル DEP-021-01**: Mixが同期APIでTelemetryへ書込。
- **参照層 DEP-021-02**: Mix→Observability。
- **依存タイプ DEP-021-03**: 同期ネットワーク。
- **兆候 DEP-021-04**: フロー中にHTTP書き込み。
- **重大度 DEP-021-05**: Medium。
- **SLI DEP-021-06**: 同期呼び出し時間。
- **検出 DEP-021-07**: トレース。
- **影響 DEP-021-08**: レイテンシ増。
- **対策 DEP-021-09**: 非同期バッファ化。
- **検証 DEP-021-10**: レイテンシテスト。
- **フォロー DEP-021-11**: Runbook。

#### ケース DEP-022: Transport→CLIデバッグユーティリティ依存
- **シグナル DEP-022-01**: TransportがCLIユーティリティへ依存。
- **参照層 DEP-022-02**: Transport→CLI。
- **依存タイプ DEP-022-03**: デバッグツール。
- **兆候 DEP-022-04**: 本番ビルドでCLIモジュールリンク。
- **重大度 DEP-022-05**: Low。
- **SLI DEP-022-06**: デバッグ依存数。
- **検出 DEP-022-07**: ビルド監査。
- **影響 DEP-022-08**: バイナリ肥大。
- **対策 DEP-022-09**: Feature flagで隔離。
- **検証 DEP-022-10**: リリースビルド確認。
- **フォロー DEP-022-11**: ビルドスクリプト更新。

#### ケース DEP-023: Secure Stream→Mixイベントスキーマ不整合
- **シグナル DEP-023-01**: イベントスキーマが不一致。
- **参照層 DEP-023-02**: Secure Stream→Mix。
- **依存タイプ DEP-023-03**: 契約。
- **兆候 DEP-023-04**: Mixが未知フィールドで失敗。
- **重大度 DEP-023-05**: High。
- **SLI DEP-023-06**: 契約テスト失敗率。
- **検出 DEP-023-07**: `testing/integration-tests.md`契約テスト。
- **影響 DEP-023-08**: イベント破棄。
- **対策 DEP-023-09**: スキーマレジストリ同期。
- **検証 DEP-023-10**: バージョン互換テスト。
- **フォロー DEP-023-11**: スキーマドキュメント更新。

#### ケース DEP-024: Mix→Obfuscation設定伝播抜け
- **シグナル DEP-024-01**: MixからObfuscationへ設定が届かない。
- **参照層 DEP-024-02**: Mix→Obfuscation。
- **依存タイプ DEP-024-03**: 設定。
- **兆候 DEP-024-04**: カバー交通が旧設定のまま。
- **重大度 DEP-024-05**: Medium。
- **SLI DEP-024-06**: 設定反映率。
- **検出 DEP-024-07**: Telemetry。
- **影響 DEP-024-08**: 匿名性低下。
- **対策 DEP-024-09**: Control経由のブロードキャストに統一。
- **検証 DEP-024-10**: 設定伝播テスト。
- **フォロー DEP-024-11**: Runbook修正。

#### ケース DEP-025: Transport→Infrastructureストレージ直結
- **シグナル DEP-025-01**: Transportが直接ストレージ操作。
- **参照層 DEP-025-02**: Transport→Storage。
- **依存タイプ DEP-025-03**: データ永続化。
- **兆候 DEP-025-04**: TransportでS3/Azure API使用。
- **重大度 DEP-025-05**: Medium。
- **SLI DEP-025-06**: 直結操作数。
- **検出 DEP-025-07**: コード解析。
- **影響 DEP-025-08**: インフラロジック漏れ。
- **対策 DEP-025-09**: Controlサービスへ一元化。
- **検証 DEP-025-10**: ストレージ統合テスト。
- **フォロー DEP-025-11**: ADRで説明。

#### ケース DEP-026: CLI→SDK内部API在庫
- **シグナル DEP-026-01**: CLIがSDK内部APIを呼び出す。
- **参照層 DEP-026-02**: CLI→SDK内部。
- **依存タイプ DEP-026-03**: API。
- **兆候 DEP-026-04**: CLIが`sdk::internal`をimport。
- **重大度 DEP-026-05**: Medium。
- **SLI DEP-026-06**: 内部API利用数。
- **検出 DEP-026-07**: 静的解析。
- **影響 DEP-026-08**: バージョン互換欠落。
- **対策 DEP-026-09**: 公開API経由に統一。
- **検証 DEP-026-10**: CLI回帰テスト。
- **フォロー DEP-026-11**: CLIドキュメント修正。

#### ケース DEP-027: SDK→Mixホップ情報参照
- **シグナル DEP-027-01**: SDKがMixホップ詳細へアクセス。
- **参照層 DEP-027-02**: クライアント→Mix内部。
- **依存タイプ DEP-027-03**: メタデータ。
- **兆候 DEP-027-04**: SDKログにホップ情報漏出。
- **重大度 DEP-027-05**: High。
- **SLI DEP-027-06**: 機密情報露出件数。
- **検出 DEP-027-07**: ログ監査。
- **影響 DEP-027-08**: 匿名性低下。
- **対策 DEP-027-09**: SDKログから除外。
- **検証 DEP-027-10**: セキュリティテスト。
- **フォロー DEP-027-11**: SDKガイド更新。

#### ケース DEP-028: Control→SDKバージョン固定化依存
- **シグナル DEP-028-01**: Controlが特定SDKバージョンに依存。
- **参照層 DEP-028-02**: Control→SDK。
- **依存タイプ DEP-028-03**: APIバージョン。
- **兆候 DEP-028-04**: ポリシー式にSDKバージョン判定。
- **重大度 DEP-028-05**: Medium。
- **SLI DEP-028-06**: 固定バージョン数。
- **検出 DEP-028-07**: コードレビュー。
- **影響 DEP-028-08**: SDKリリース制約。
- **対策 DEP-028-09**: Capabilityネゴシエーション。
- **検証 DEP-028-10**: バージョン互換テスト。
- **フォロー DEP-028-11**: ADR。

#### ケース DEP-029: Observability→CLI操作依存
- **シグナル DEP-029-01**: 監視がCLI手動操作でしか回復できない。
- **参照層 DEP-029-02**: Observability→CLI。
- **依存タイプ DEP-029-03**: 運用手順。
- **兆候 DEP-029-04**: RunbookにCLI必須。
- **重大度 DEP-029-05**: Low。
- **SLI DEP-029-06**: 手動依存数。
- **検出 DEP-029-07**: Runbookレビュー。
- **影響 DEP-029-08**: 自動化不足。
- **対策 DEP-029-09**: APIベースへ置換。
- **検証 DEP-029-10**: Runbook演習。
- **フォロー DEP-029-11**: 手順更新。

#### ケース DEP-030: Transport→Cryptoライブラリ互換崩壊
- **シグナル DEP-030-01**: Transportが古い暗号ライブラリ使用。
- **参照層 DEP-030-02**: Transport→Crypto。
- **依存タイプ DEP-030-03**: ライブラリ。
- **兆候 DEP-030-04**: `nyx-crypto`指定バージョン逸脱。
- **重大度 DEP-030-05**: High。
- **SLI DEP-030-06**: ライブラリ整合率。
- **検出 DEP-030-07**: Cargoチェック。
- **影響 DEP-030-08**: セキュリティ低下。
- **対策 DEP-030-09**: ワークスペースで固定。
- **検証 DEP-030-10**: 暗号互換テスト。
- **フォロー DEP-030-11**: セキュリティレビュー。

#### ケース DEP-031: SDK→テスト用スタブ依存
- **シグナル DEP-031-01**: SDKがテストスタブへ依存。
- **参照層 DEP-031-02**: SDK→tests。
- **依存タイプ DEP-031-03**: ビルド時リンク。
- **兆候 DEP-031-04**: `cfg(test)`モジュールを本番利用。
- **重大度 DEP-031-05**: Medium。
- **SLI DEP-031-06**: スタブ参照数。
- **検出 DEP-031-07**: Lint。
- **影響 DEP-031-08**: 本番挙動不確実。
- **対策 DEP-031-09**: スタブをモックライブラリ化。
- **検証 DEP-031-10**: ビルドチェック。
- **フォロー DEP-031-11**: コントリビュートガイド更新。

#### ケース DEP-032: Control→部署別設定ファイル重複依存
- **シグナル DEP-032-01**: 部署別設定が複数場所で重複。
- **参照層 DEP-032-02**: Control。
- **依存タイプ DEP-032-03**: ファイル依存。
- **兆候 DEP-032-04**: 同一設定が`nyx.toml`と`control.yaml`で2重記載。
- **重大度 DEP-032-05**: Medium。
- **SLI DEP-032-06**: 重複設定数。
- **検出 DEP-032-07**: IaC差分チェッカ。
- **影響 DEP-032-08**: ドリフト。
- **対策 DEP-032-09**: 単一ソース化。
- **検証 DEP-032-10**: テンプレート生成テスト。
- **フォロー DEP-032-11**: Runbook。

#### ケース DEP-033: Observability→外部SaaS依存評価不足
- **シグナル DEP-033-01**: 外部SaaSへ依存しながらSLA未評価。
- **参照層 DEP-033-02**: Observability→SaaS。
- **依存タイプ DEP-033-03**: サードパーティ。
- **兆候 DEP-033-04**: SLA未署名。
- **重大度 DEP-033-05**: Medium。
- **SLI DEP-033-06**: 契約評価率。
- **検出 DEP-033-07**: ベンダ管理レビュー。
- **影響 DEP-033-08**: 観測欠落リスク。
- **対策 DEP-033-09**: SL A締結とフェイルオーバ準備。
- **検証 DEP-033-10**: DR演習。
- **フォロー DEP-033-11**: ベンダレジスタ更新。

#### ケース DEP-034: テンプレート→実装参照の逆流
- **シグナル DEP-034-01**: ドキュメントテンプレートが実装詳細を包含。
- **参照層 DEP-034-02**: docs/templates→src。
- **依存タイプ DEP-034-03**: ドキュメント。
- **兆候 DEP-034-04**: テンプレで実装モジュール名固定。
- **重大度 DEP-034-05**: Low。
- **SLI DEP-034-06**: 実装固有参照数。
- **検出 DEP-034-07**: ドキュメントLint。
- **影響 DEP-034-08**: テンプレ再利用性低下。
- **対策 DEP-034-09**: 抽象化。
- **検証 DEP-034-10**: テンプレレビュー。
- **フォロー DEP-034-11**: docsガイド更新。

#### ケース DEP-035: Mix→Cryptoバージョン遅延
- **シグナル DEP-035-01**: Mixが古い暗号クレート利用。
- **参照層 DEP-035-02**: Mix→nyx-crypto。
- **依存タイプ DEP-035-03**: ライブラリ。
- **兆候 DEP-035-04**: バージョン固定化。
- **重大度 DEP-035-05**: High。
- **SLI DEP-035-06**: バージョン遅延期間。
- **検出 DEP-035-07**: GitHubセキュリティアラート。
- **影響 DEP-035-08**: セキュリティ脆弱性。
- **対策 DEP-035-09**: Dependabot適用。
- **検証 DEP-035-10**: 暗号テスト。
- **フォロー DEP-035-11**: セキュリティレポート。

#### ケース DEP-036: Obfuscation→CLIログフォーマット依存
- **シグナル DEP-036-01**: ObfuscationログがCLIフォーマットと一致必須。
- **参照層 DEP-036-02**: Obfuscation→CLI。
- **依存タイプ DEP-036-03**: ログフォーマット。
- **兆候 DEP-036-04**: CLI更新でObfログ解析失敗。
- **重大度 DEP-036-05**: Low。
- **SLI DEP-036-06**: 解析失敗率。
- **検出 DEP-036-07**: ログ消費テスト。
- **影響 DEP-036-08**: デバッグ困難。
- **対策 DEP-036-09**: 標準ログ仕様策定。
- **検証 DEP-036-10**: 互換テスト。
- **フォロー DEP-036-11**: ログ仕様書更新。

#### ケース DEP-037: Control→テストCI設定逆流
- **シグナル DEP-037-01**: テスト用設定が本番Controlに流入。
- **参照層 DEP-037-02**: Control→tests。
- **依存タイプ DEP-037-03**: 設定。
- **兆候 DEP-037-04**: 本番で`mock`フラグ有効。
- **重大度 DEP-037-05**: High。
- **SLI DEP-037-06**: テストフラグ検知件数。
- **検出 DEP-037-07**: CIで環境差分検査。
- **影響 DEP-037-08**: 本番障害。
- **対策 DEP-037-09**: 設定分離。
- **検証 DEP-037-10**: 本番環境シミュレーション。
- **フォロー DEP-037-11**: Runbook修正。

#### ケース DEP-038: Transport→UI通知依存
- **シグナル DEP-038-01**: TransportがUI通知サービスへ依頼。
- **参照層 DEP-038-02**: Transport→UI。
- **依存タイプ DEP-038-03**: 通知API。
- **兆候 DEP-038-04**: TransportコードにUIエンドポイント。
- **重大度 DEP-038-05**: Medium。
- **SLI DEP-038-06**: 通知呼び出し数。
- **検出 DEP-038-07**: コード検索。
- **影響 DEP-038-08**: 階層違反。
- **対策 DEP-038-09**: Control経由通知。
- **検証 DEP-038-10**: 通知フロー確認。
- **フォロー DEP-038-11**: UIガイド更新。

#### ケース DEP-039: Observability→Formal検証ツール依存
- **シグナル DEP-039-01**: 観測層がformal解析結果に直接依存。
- **参照層 DEP-039-02**: Observability→formal。
- **依存タイプ DEP-039-03**: データ供給。
- **兆候 DEP-039-04**: テレメトリがTLA+出力なしで停止。
- **重大度 DEP-039-05**: Low。
- **SLI DEP-039-06**: Formal依存件数。
- **検出 DEP-039-07**: パイプラインレビュー。
- **影響 DEP-039-08**: 実行フロー停止。
- **対策 DEP-039-09**: Formal結果をOptional扱い。
- **検証 DEP-039-10**: Formal停止演習。
- **フォロー DEP-039-11**: Runbook。

#### ケース DEP-040: CLI→deploymentスクリプト依存
- **シグナル DEP-040-01**: CLIが成否判定にデプロイスクリプトを呼ぶ。
- **参照層 DEP-040-02**: CLI→deployment。
- **依存タイプ DEP-040-03**: スクリプト実行。
- **兆候 DEP-040-04**: CLIコマンドが`make deploy`を呼ぶ。
- **重大度 DEP-040-05**: Medium。
- **SLI DEP-040-06**: スクリプト依存数。
- **検出 DEP-040-07**: コマンド監査。
- **影響 DEP-040-08**: CLI失敗がデプロイに影響。
- **対策 DEP-040-09**: APIベースの依存へ移行。
- **検証 DEP-040-10**: CLI統合テスト。
- **フォロー DEP-040-11**: CLIドキュメント。

#### ケース DEP-041: Mix→testingユーティリティ取り込み
- **シグナル DEP-041-01**: Mixがテストユーティリティへ依存。
- **参照層 DEP-041-02**: Mix→tests。
- **依存タイプ DEP-041-03**: 開発支援。
- **兆候 DEP-041-04**: 本番コンパイルでテストクレート含む。
- **重大度 DEP-041-05**: Medium。
- **SLI DEP-041-06**: テスト依存数。
- **検出 DEP-041-07**: Feature Flagチェック。
- **影響 DEP-041-08**: ビルドサイズ増。
- **対策 DEP-041-09**: テストクレート分離。
- **検証 DEP-041-10**: ビルド監査。
- **フォロー DEP-041-11**: ガイド更新。

#### ケース DEP-042: Control→docsテンプレート依存
- **シグナル DEP-042-01**: Controlがドキュメントテンプレートを参照。
- **参照層 DEP-042-02**: Control→docs。
- **依存タイプ DEP-042-03**: ファイルIO。
- **兆候 DEP-042-04**: Controlが`templates/module-template.md`を読み込み。
- **重大度 DEP-042-05**: Low。
- **SLI DEP-042-06**: ファイル依存数。
- **検出 DEP-042-07**: コードレビュー。
- **影響 DEP-042-08**: 配布アーティファクト膨張。
- **対策 DEP-042-09**: 設定で外部化。
- **検証 DEP-042-10**: ビルド確認。
- **フォロー DEP-042-11**: ドキュメント整備。

#### ケース DEP-043: Observability→Mixノード配置情報過依存
- **シグナル DEP-043-01**: 観測がMixノード配置データに固定依存。
- **参照層 DEP-043-02**: Observability→Mix。
- **依存タイプ DEP-043-03**: メタデータ。
- **兆候 DEP-043-04**: ノード移動でDashboard崩壊。
- **重大度 DEP-043-05**: Medium。
- **SLI DEP-043-06**: ダッシュボードエラー率。
- **検出 DEP-043-07**: ダッシュボードテスト。
- **影響 DEP-043-08**: 可観測性低下。
- **対策 DEP-043-09**: ディレクトリAPI利用。
- **検証 DEP-043-10**: Dashboard合成テスト。
- **フォロー DEP-043-11**: Grafana設定更新。

#### ケース DEP-044: Stream→Deployment IaC依存
- **シグナル DEP-044-01**: StreamがIaCファイルを参照。
- **参照層 DEP-044-02**: Stream→deployment。
- **依存タイプ DEP-044-03**: 設定ファイル。
- **兆候 DEP-044-04**: Streamが`kind-config.yaml`から値取得。
- **重大度 DEP-044-05**: Medium。
- **SLI DEP-044-06**: 外部設定読込数。
- **検出 DEP-044-07**: 静的解析。
- **影響 DEP-044-08**: ビルド環境依存。
- **対策 DEP-044-09**: 設定サービス利用。
- **検証 DEP-044-10**: ビルド再現性テスト。
- **フォロー DEP-044-11**: IaC文書更新。

#### ケース DEP-045: テンプレート→CI設定依存
- **シグナル DEP-045-01**: テンプレート更新がCI破壊。
- **参照層 DEP-045-02**: docs/templates→CI。
- **依存タイプ DEP-045-03**: 文書依存。
- **兆候 DEP-045-04**: テンプレ修正でCI失敗。
- **重大度 DEP-045-05**: Low。
- **SLI DEP-045-06**: 依存失敗件数。
- **検出 DEP-045-07**: CI監視。
- **影響 DEP-045-08**: ドキュメント変更抑制。
- **対策 DEP-045-09**: CIテンプレ分離。
- **検証 DEP-045-10**: テンプレ更新テスト。
- **フォロー DEP-045-11**: Contributingガイド。

#### ケース DEP-046: CLI→Observabilityメトリクス依存
- **シグナル DEP-046-01**: CLI結果判定がメトリクス取得前提。
- **参照層 DEP-046-02**: CLI→Observability。
- **依存タイプ DEP-046-03**: API。
- **兆候 DEP-046-04**: CLIでPrometheusクエリ。
- **重大度 DEP-046-05**: Medium。
- **SLI DEP-046-06**: API呼び出し数。
- **検出 DEP-046-07**: CLIログ。
- **影響 DEP-046-08**: 観測基盤障害時にCLI不可。
- **対策 DEP-046-09**: Control APIへフェイルオーバ。
- **検証 DEP-046-10**: 監視停止演習。
- **フォロー DEP-046-11**: CLIドキュメント改訂。

#### ケース DEP-047: Transport→formal検証結果固定依存
- **シグナル DEP-047-01**: Transportがformal検証済み設定番号を直接参照。
- **参照層 DEP-047-02**: Transport→formal。
- **依存タイプ DEP-047-03**: 設定コード。
- **兆候 DEP-047-04**: Transportで`formal.states`読み込み。
- **重大度 DEP-047-05**: Low。
- **SLI DEP-047-06**: 直接参照数。
- **検出 DEP-047-07**: コードReview。
- **影響 DEP-047-08**: 柔軟性低下。
- **対策 DEP-047-09**: Formal結果をPolicyへ反映し参照。
- **検証 DEP-047-10**: Formalベース演習。
- **フォロー DEP-047-11**: formalガイド。

#### ケース DEP-048: Control→mobile FFI API依存
- **シグナル DEP-048-01**: ControlがモバイルFFIへ直アクセス。
- **参照層 DEP-048-02**: Control→nyx-mobile-ffi。
- **依存タイプ DEP-048-03**: FFI。
- **兆候 DEP-048-04**: Control内でFFIバインディング利用。
- **重大度 DEP-048-05**: Medium。
- **SLI DEP-048-06**: FFI呼び出し数。
- **検出 DEP-048-07**: ビルドログ。
- **影響 DEP-048-08**: ポリシー層が端末依存。
- **対策 DEP-048-09**: SDK API活用。
- **検証 DEP-048-10**: Control統合テスト。
- **フォロー DEP-048-11**: ADR。

#### ケース DEP-049: Observability→deploymentログ解析依存
- **シグナル DEP-049-01**: 観測がデプロイログを前提。
- **参照層 DEP-049-02**: Observability→deployment。
- **依存タイプ DEP-049-03**: ログ解析。
- **兆候 DEP-049-04**: 新デプロイ方式で観測壊滅。
- **重大度 DEP-049-05**: Medium。
- **SLI DEP-049-06**: ログ依存度指数。
- **検出 DEP-049-07**: ログフォーマット差分。
- **影響 DEP-049-08**: 観測断。
- **対策 DEP-049-09**: APIベースのデプロイイベント利用。
- **検証 DEP-049-10**: デプロイテスト。
- **フォロー DEP-049-11**: デプロイドキュメント更新。

#### ケース DEP-050: SDK→notesドキュメント参照
- **シグナル DEP-050-01**: SDKが`notes/`文書を参照。
- **参照層 DEP-050-02**: SDK→docs/notes。
- **依存タイプ DEP-050-03**: ドキュメントIO。
- **兆候 DEP-050-04**: SDKで決定ログをパース。
- **重大度 DEP-050-05**: Low。
- **SLI DEP-050-06**: 文書参照数。
- **検出 DEP-050-07**: コードレビュー。
- **影響 DEP-050-08**: SDK挙動が文書変更で変化。
- **対策 DEP-050-09**: 設定サービスへ情報移行。
- **検証 DEP-050-10**: SDKリリーステスト。
- **フォロー DEP-050-11**: ドキュメント用途明確化。

## 関連ドキュメント
- [architecture/overview.md](./overview.md)
- [architecture/interfaces.md](./interfaces.md)
- [deployment/ci-cd.md](../deployment/ci-cd.md)
- [templates/module-template.md](../templates/module-template.md)

> **宣言**: 本章は実装コードを含まず、C/C++依存の設計を排除する。