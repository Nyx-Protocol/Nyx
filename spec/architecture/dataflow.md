# docs/architecture/dataflow.md

> **遵守バッジ** : :no_entry: 実装コード非出力 / :no_entry_sign: C/C++依存禁止

## 目次
- [目的](#目的)
- [同期フロー](#同期フロー)
- [非同期/イベントフロー](#非同期イベントフロー)
- [データ整合性・冪等性](#データ整合性冪等性)
- [監視ポイントと回復戦略](#監視ポイントと回復戦略)
- [バックプレッシャとレート制御](#バックプレッシャとレート制御)
- [関連ドキュメント](#関連ドキュメント)

## 目的
Nyxプロトコルにおける主要処理フロー（セッション確立、データ転送、監査ログ生成）のデータパスを明確化し、整合性、冪等性、回復戦略を定義する。アーキテクチャ概要は[overview.md](./overview.md)を参照。

## 同期フロー
### セッション確立シーケンス
```
Client -> Stream Layer: SESSION_INIT(request)
Stream Layer -> Control: POLICY_CHECK(context)
Control -> Stream Layer: POLICY_ACCEPT
Stream Layer -> Mix Layer: ROUTE_REQUEST
Mix Layer -> Directory Service: NODE_QUERY
Directory Service -> Mix Layer: NODE_RESPONSE
Mix Layer -> Stream Layer: ROUTE_PLAN
Stream Layer -> Client: SESSION_READY(token)
Client <-> Stream Layer: FRAME_EXCHANGE (0-RTT data)
```
- **SLI**: セッション確立時間 (Target: \u2264 150ms)
- **冪等性**: `SESSION_INIT`は重複トランザクション防止のため、クライアントID+Nonceで整合性を確保。

### データ転送フロー
```
Client -> Stream Layer: STREAM_DATA(stream_id, payload)
Stream Layer -> Mix Layer: ENCRYPTED_FRAME
Mix Layer -> Obfuscation: ROUTED_PACKET
Obfuscation -> Transport: OBFUSCATED_PACKET
Transport -> Network: DATAGRAM_SEND
Network -> Transport -> ... -> Client
```
- **エラー処理**: 各段階で`ACK/NACK`フレームを返却。再送制御はStream Layerが担当。

## 非同期/イベントフロー
### カバー交通・適応制御
```
Scheduler -> Obfuscation: COVER_TRAFFIC_PLAN(λ)
Obfuscation -> Transport: DUMMY_PACKET_EMIT
Monitoring -> Control: TELEMETRY_REPORT
Control -> Scheduler: ADJUST_RATE(λ')
```
- λはPoisson分布パラメータ。モバイル状況に応じて動的調整。

### 監査ログパイプライン
```
Control Event -> Audit Bus: AUDIT_EVENT
Audit Bus -> Compliance Store: STORE_EVENT
Compliance Store -> Analytics: STREAM_EXPORT
Analytics -> Dashboard: INSIGHT_UPDATE
```
- **データ保持**: 不変ストレージで暗号化保存。アクセスはRBAC/ABAC。

## データ整合性・冪等性
| 項目 | 戦略 | 説明 |
|------|------|------|
| セッションレコード | 楽観的ロック | Duplicate detection by `session_token` |
| メッセージ再送 | 冪等トークン | 各フレームに`seq_no`と`replay_guard` |
| 監査ログ | イミュータブルストア | 追記専用ストレージ + ハッシュ鎖 |
| 設定更新 | イベントソーシング | `CONFIG_CHANGE`イベントをリプレイ可能 |

## 監視ポイントと回復戦略
| 障害シナリオ | 検知ポイント | 回復策 | 関連文書 |
|--------------|--------------|--------|----------|
| ノード応答遅延 | MixレイヤSLI (P95) | 代替ルートへのフェイルオーバ | [performance/scalability.md](../performance/scalability.md) |
| FEC過剰 | Obfuscationメトリクス | 冗長度削減の動的制御 | [performance/benchmark.md](../performance/benchmark.md) |
| 監査ログ遅延 | Audit Busバックログ | Priority boost & スロット増 | [security/auth.md](../security/auth.md) |
| セッション失敗 | Stream Layer失敗率 | 再試行とヒューリスティック調整 | [testing/integration-tests.md](../testing/integration-tests.md) |

## バックプレッシャとレート制御
- **ストリーム単位**: ウィンドウサイズはRTTと損失率に基づき適応。QoSは優先度キューで実現。
- **ミックスレイヤ**: ノード負荷メトリクスを参照し、過負荷ノードへは新規ルート割当を停止。
- **オブフスケーション層**: λの上下限を設定（min λ=5pps, max λ=50pps モバイル）。
- **Transport層**: QUIC類似のCCアルゴリズム（BBR派生）を設定可能、ただし実装はC/C++禁止によりマネージド言語で提供。

## 拡張補遺: データフロー診断カタログ

本補遺は、Nyxにおける同期・非同期フローを横断し、各フローの健全性とスケーラビリティを検証するための運用シナリオ50件を体系化する。各シナリオは焦点、対象フローステージ、トリガ、負荷条件、重要SLI、可観測性、依存関係、リスク、推奨対策、検証手段、フォローアップの11要素で構成され、トラブルシューティングとキャパシティ計画の両面を支援する。

#### シナリオ DF-001: セッション確立フローのBurst吸収
- **焦点 DF-001-01**: `SESSION_INIT`連打時にStream→Control→Mix連携が飽和しないか確認。
- **フロー段階 DF-001-02**: 同期確立シーケンス。
- **トリガ DF-001-03**: 新バージョンリリース直後にSDKが大量再接続。
- **負荷条件 DF-001-04**: 1秒あたり1500リクエスト、Policyチェック平均4ms。
- **重要SLI DF-001-05**: セッション確立P95≦180ms。
- **可観測性 DF-001-06**: `telemetry.session_handshake_latency`を時間窓5秒で評価。
- **依存 DF-001-07**: `security/auth.md`に定義されたトークンサービス稼働。
- **リスク DF-001-08**: Control層のレートリミッタが飽和し拒否率増。
- **推奨 DF-001-09**: バックプレッシャ閾値を`CONFIG_CHANGE`イベントで段階引上げ。
- **検証 DF-001-10**: `testing/e2e-tests.md`の負荷スクリプトで72時間連続試験。
- **フォローアップ DF-001-11**: 結果を`notes/decision-log.md`へ記載し次回リリース計画へ反映。

#### シナリオ DF-002: Policyキャッシュ失効時の確立遅延
- **焦点 DF-002-01**: Control層ポリシーキャッシュが一斉失効した際の影響を測定。
- **フロー段階 DF-002-02**: セッション確立中の`POLICY_CHECK`。
- **トリガ DF-002-03**: ガバナンスポリシー改定で全キャッシュ更新。
- **負荷条件 DF-002-04**: 5分間に20万件のキャッシュミス。
- **重要SLI DF-002-05**: 確立失敗率≦0.2%。
- **可観測性 DF-002-06**: Control層の`policy_cache_miss`メトリクスを監視。
- **依存 DF-002-07**: `deployment/ci-cd.md`のロールアウト順守。
- **リスク DF-002-08**: バックエンドDBがスパイク負荷で遅延。
- **推奨 DF-002-09**: 分散キャッシュの段階更新とリードスルー設定。
- **検証 DF-002-10**: 部分的キャッシュ無効テストを実施し遅延変化を記録。
- **フォローアップ DF-002-11**: `docs/compliance_ci_integration.md`へ教訓を追記。

#### シナリオ DF-003: Mix経路探索とStream同期ズレ
- **焦点 DF-003-01**: Route計算遅延でStreamのタイムアウトが発生しないか確認。
- **フロー段階 DF-003-02**: `ROUTE_REQUEST`→`ROUTE_PLAN`返却。
- **トリガ DF-003-03**: ディレクトリサービス再スキャンによるノード遅延。
- **負荷条件 DF-003-04**: 平均探索時間200msへ悪化。
- **重要SLI DF-003-05**: タイムアウト率≦0.5%。
- **可観測性 DF-003-06**: `mix.route_plan_latency`にアラート設定。
- **依存 DF-003-07**: `architecture/dependencies.md`のタイムアウト契約に準拠。
- **リスク DF-003-08**: 再試行増加でControl層へ負荷連鎖。
- **推奨 DF-003-09**: Stream側のタイムアウトを自動調整し、Grace延長。
- **検証 DF-003-10**: シミュレータで探索遅延を段階増加させ検証。
- **フォローアップ DF-003-11**: 結果を`performance/scalability.md`へフィード。

#### シナリオ DF-004: データ転送フレームの再送嵐
- **焦点 DF-004-01**: 再送制御が連鎖的に発生し帯域を圧迫しないか評価。
- **フロー段階 DF-004-02**: Stream→Mix→Obfuscationの送信ループ。
- **トリガ DF-004-03**: 一時的パケットロス率15%。
- **負荷条件 DF-004-04**: 同時ストリーム500、再送率20%。
- **重要SLI DF-004-05**: 効率化後の再送率≦5%。
- **可観測性 DF-004-06**: `transport.retransmission_ratio`をヒートマップ化。
- **依存 DF-004-07**: FEC設定が`nyx-fec`の推奨値内。
- **リスク DF-004-08**: 冗長再送でカバー交通に割当帯域が不足。
- **推奨 DF-004-09**: 適応型再送アルゴリズムの閾値調整。
- **検証 DF-004-10**: `performance/benchmark.md`の再送テストを延長。
- **フォローアップ DF-004-11**: `notes/meeting-notes.md`で再送対策レビュー。

#### シナリオ DF-005: データ転送フローのQoS分離検証
- **焦点 DF-005-01**: 複数QoSクラスが同一フローを利用する際の干渉を測定。
- **フロー段階 DF-005-02**: Stream QoSタグ→Transport帯域制御。
- **トリガ DF-005-03**: プレミアムチャネル導入。
- **負荷条件 DF-005-04**: 高優先度30%、標準70%。
- **重要SLI DF-005-05**: 高優先度遅延≦120ms。
- **可観測性 DF-005-06**: QoSタグ別の`stream.latency_p95`を監視。
- **依存 DF-005-07**: `architecture/interfaces.md`のQoS契約フィールド。
- **リスク DF-005-08**: 優先度設定が不整合でSLA違反。
- **推奨 DF-005-09**: 帯域予約をTransportで構成。
- **検証 DF-005-10**: テストハーネスでQoS混在シナリオを実行。
- **フォローアップ DF-005-11**: SLA結果を`docs/specs.md`へ反映。

#### シナリオ DF-006: カバー交通フローの無限ループ検知
- **焦点 DF-006-01**: Obfuscation計画がTransportへの過剰指示でループ化しないか確認。
- **フロー段階 DF-006-02**: Scheduler→Obfuscation→Transport。
- **トリガ DF-006-03**: λ調整ロジックの設定ミス。
- **負荷条件 DF-006-04**: DUMMY_PACKETが5倍増。
- **重要SLI DF-006-05**: Cover/Real比率≦60%。
- **可観測性 DF-006-06**: `obf.cover_ratio`アラート閾値45%。
- **依存 DF-006-07**: `adaptive_cover_traffic_spec.md`の上限遵守。
- **リスク DF-006-08**: 帯域圧迫で本流遅延増。
- **推奨 DF-006-09**: SchedulerからTransportへのループ保護。
- **検証 DF-006-10**: ループ検知単体テストをCIに追加。
- **フォローアップ DF-006-11**: 事象と対策を`notes/decision-log.md`へ記録。

#### シナリオ DF-007: Telemetry遅延とフローバックログ
- **焦点 DF-007-01**: Telemetry遅延でバックプレッシャ判断が遅れないか検証。
- **フロー段階 DF-007-02**: Monitoring→Control→Scheduler。
- **トリガ DF-007-03**: Observability層に一時的遅延。
- **負荷条件 DF-007-04**: Telemetry到達遅延平均3秒。
- **重要SLI DF-007-05**: レート調整反応時間≦1秒。
- **可観測性 DF-007-06**: `telemetry.pipeline_lag_seconds`を可視化。
- **依存 DF-007-07**: `performance/scalability.md`のキャパ計画。
- **リスク DF-007-08**: 過負荷判定が遅れ、セッション断発生。
- **推奨 DF-007-09**: ローカルヒューリスティックをStream層へ導入。
- **検証 DF-007-10**: Telemetry遅延シナリオで統合テスト。
- **フォローアップ DF-007-11**: Runbook更新。

#### シナリオ DF-008: Auditイベントフローのスロット枯渇
- **焦点 DF-008-01**: Audit Busが高負荷でスロット不足になる際の影響を評価。
- **フロー段階 DF-008-02**: Control Event→Audit Bus→Compliance Store。
- **トリガ DF-008-03**: 規制報告期間のバッチ出力。
- **負荷条件 DF-008-04**: AUDIT_EVENTが通常比4倍。
- **重要SLI DF-008-05**: 遅延≦30秒。
- **可観測性 DF-008-06**: `audit.queue_depth`アラート。
- **依存 DF-008-07**: `security/vulnerability.md`の監査要件。
- **リスク DF-008-08**: 監査ログ欠損で遵守違反。
- **推奨 DF-008-09**: スロット自動拡張と優先度キュー導入。
- **検証 DF-008-10**: サージテストでレイテンシ計測。
- **フォローアップ DF-008-11**: レポートを`compliance_ci_integration.md`へ。

#### シナリオ DF-009: イミュータブル監査ストアのリプレイ検証
- **焦点 DF-009-01**: ハッシュ鎖リプレイが遅延なく実行できるか確認。
- **フロー段階 DF-009-02**: Audit Bus→Compliance Store→Analytics。
- **トリガ DF-009-03**: 外部監査で30日分を一括検証。
- **負荷条件 DF-009-04**: 1億イベントの連続リプレイ。
- **重要SLI DF-009-05**: リプレイ成功率100%、処理速度≧5k/s。
- **可観測性 DF-009-06**: `audit.replay_throughput`メトリクス。
- **依存 DF-009-07**: `docs/specs.md`の監査要件。
- **リスク DF-009-08**: 追記ストアのI/O飽和。
- **推奨 DF-009-09**: バックプレッシャ制御をAnalytics側で実装。
- **検証 DF-009-10**: リプレイベンチマークを実施。
- **フォローアップ DF-009-11**: 結果を`notes/decision-log.md`へ保存。

#### シナリオ DF-010: 設定イベントのデッドレタ発生
- **焦点 DF-010-01**: `CONFIG_CHANGE`イベントがデッドレタに落ちた際の回復手順を整備。
- **フロー段階 DF-010-02**: Control→各レイヤ設定Walker。
- **トリガ DF-010-03**: 設定ペイロードの検証失敗。
- **負荷条件 DF-010-04**: デッドレタ率5%。
- **重要SLI DF-010-05**: 再配信完了まで≦120秒。
- **可観測性 DF-010-06**: `config.dead_letter_count`ダッシュボード。
- **依存 DF-010-07**: `docs/configuration.md`のフォールバック手順。
- **リスク DF-010-08**: レイヤ間設定不整合。
- **推奨 DF-010-09**: 自動再キューと運用アラート。
- **検証 DF-010-10**: フェイルケースを統合テストへ追加。
- **フォローアップ DF-010-11**: 手順をRunbook更新。

#### シナリオ DF-011: Streamフレーム圧縮比率異常
- **焦点 DF-011-01**: フレーム圧縮後サイズが突然増加した場合の影響。
- **フロー段階 DF-011-02**: Client→Stream→Mixフレーム処理。
- **トリガ DF-011-03**: 新アプリが圧縮非対応。
- **負荷条件 DF-011-04**: 平均フレーム1.4KB→2.1KB。
- **重要SLI DF-011-05**: MTU断片化率≦8%。
- **可観測性 DF-011-06**: `stream.compressed_frame_size`ヒストグラム。
- **依存 DF-011-07**: `architecture/interfaces.md`の圧縮契約。
- **リスク DF-011-08**: Transport断片化で遅延。
- **推奨 DF-011-09**: 圧縮能力を交渉しフォールバック適用。
- **検証 DF-011-10**: 圧縮互換テストをCI追加。
- **フォローアップ DF-011-11**: 結果を`docs/specs.md`更新。

#### シナリオ DF-012: Mixディレクトリの部分障害
- **焦点 DF-012-01**: ディレクトリサービス分割障害でフローが継続できるか評価。
- **フロー段階 DF-012-02**: Mix→Directory問い合わせ。
- **トリガ DF-012-03**: リージョン分割で半数ノード情報不能。
- **負荷条件 DF-012-04**: NODE_RESPONSE成功率70%。
- **重要SLI DF-012-05**: 代替経路生成率≧95%。
- **可観測性 DF-012-06**: `directory.query_success_ratio`監視。
- **依存 DF-012-07**: `architecture/dependencies.md`のフェイルオーバ設計。
- **リスク DF-012-08**: 経路が集中し匿名性低下。
- **推奨 DF-012-09**: キャッシュ活用と外部バックアップ。
- **検証 DF-012-10**: 障害注入テストを実施。
- **フォローアップ DF-012-11**: 報告を`notes/decision-log.md`へ。

#### シナリオ DF-013: Obfuscationタイミングノイズの過剰適用
- **焦点 DF-013-01**: 送出間隔ノイズが大きすぎて同期が崩れないか評価。
- **フロー段階 DF-013-02**: Obfuscation→Transport送出。
- **トリガ DF-013-03**: 防諜強化設定の誤適用。
- **負荷条件 DF-013-04**: ノイズ幅0〜120ms。
- **重要SLI DF-013-05**: エンドツーエンド遅延≦400ms。
- **可観測性 DF-013-06**: `obf.timing_jitter_ms`を監視。
- **依存 DF-013-07**: `adaptive_cover_traffic_spec.md`の上限。
- **リスク DF-013-08**: 高遅延でUX低下。
- **推奨 DF-013-09**: セグメント別ノイズ幅制御。
- **検証 DF-013-10**: A/Bテストで遅延比較。
- **フォローアップ DF-013-11**: UXレビューを`docs/notes/meeting-notes.md`へ。

#### シナリオ DF-014: Transportのジッター抑制フィードバック遅延
- **焦点 DF-014-01**: ジッター制御フィードバックが遅延しないか分析。
- **フロー段階 DF-014-02**: Transport→Streamへの通知。
- **トリガ DF-014-03**: Telemetryサンプリング低下。
- **負荷条件 DF-014-04**: ジッター計測周期5秒→15秒。
- **重要SLI DF-014-05**: ジッターP95≦30ms。
- **可観測性 DF-014-06**: `transport.jitter_feedback_latency`。
- **依存 DF-014-07**: `performance/benchmark.md`の制御ループ。
- **リスク DF-014-08**: 調整遅れでジッター悪化。
- **推奨 DF-014-09**: ローカル測定をStream層で補完。
- **検証 DF-014-10**: フィードバック遅延テスト。
- **フォローアップ DF-014-11**: 調整案をRunbookへ。

#### シナリオ DF-015: セッション終了イベント遅延
- **焦点 DF-015-01**: `SESSION_TERMINATE`遅延でリソースリークが起きないか確認。
- **フロー段階 DF-015-02**: Client→Stream→Control→Audit。
- **トリガ DF-015-03**: クライアント異常終了。
- **負荷条件 DF-015-04**: 終了イベント遅延平均20秒。
- **重要SLI DF-015-05**: リソース解放成功率≧99.8%。
- **可観測性 DF-015-06**: `stream.session_close_lag`。
- **依存 DF-015-07**: `docs/templates/module-template.md`の終了フック標準。
- **リスク DF-015-08**: リソース保持でコスト増。
- **推奨 DF-015-09**: タイムアウトで自動終了、監査ログ記録。
- **検証 DF-015-10**: 異常終了E2Eテスト追加。
- **フォローアップ DF-015-11**: 対応状況を`notes/decision-log.md`へ。

#### シナリオ DF-016: フレーム並列復号の同期失敗
- **焦点 DF-016-01**: 並列復号が順序保証を壊さないか評価。
- **フロー段階 DF-016-02**: Mix→Obfuscation復号。
- **トリガ DF-016-03**: 並列度を16へ拡大。
- **負荷条件 DF-016-04**: フレーム順序乱れ率2%。
- **重要SLI DF-016-05**: 再並列後順序エラー≦0.01%。
- **可観測性 DF-016-06**: `obf.reorder_corrections`。
- **依存 DF-016-07**: `architecture/interfaces.md`のフレーム序数ルール。
- **リスク DF-016-08**: 順序崩壊でアプリ側再生破綻。
- **推奨 DF-016-09**: 序数バッファ閾値監視。
- **検証 DF-016-10**: 並列レベル別テスト。
- **フォローアップ DF-016-11**: 結果を`performance/benchmark.md`へ。

#### シナリオ DF-017: Mixホップ内でのFEC挿入整合性
- **焦点 DF-017-01**: MixノードがFECブロックを正しく透過させるか検証。
- **フロー段階 DF-017-02**: Stream→Mix→Obfuscation。
- **トリガ DF-017-03**: 新FECスキーム導入。
- **負荷条件 DF-017-04**: 冗長率25%。
- **重要SLI DF-017-05**: FEC再構成成功率≧99.6%。
- **可観測性 DF-017-06**: `fec.recovery_ratio`。
- **依存 DF-017-07**: `nyx-fec/README.md`仕様準拠。
- **リスク DF-017-08**: Mixノードで冗長パケット破棄。
- **推奨 DF-017-09**: MixでFECタグ認識を強制。
- **検証 DF-017-10**: フロー統合テスト。
- **フォローアップ DF-017-11**: 仕様補足を`architecture/dataflow.md`本文へ反映。

#### シナリオ DF-018: Controlイベントの順序逆転
- **焦点 DF-018-01**: 設定イベントが順序逆転した際の整合性確保。
- **フロー段階 DF-018-02**: Control→Stream/Obfuscation適用。
- **トリガ DF-018-03**: メッセージバス遅延。
- **負荷条件 DF-018-04**: 逆転発生率0.5%。
- **重要SLI DF-018-05**: 不整合発生0件。
- **可観測性 DF-018-06**: `config.applied_version`メトリクス。
- **依存 DF-018-07**: `docs/configuration.md`のバージョンガード。
- **リスク DF-018-08**: ハンドシェイクが旧設定で動作。
- **推奨 DF-018-09**: Idempotent適用ロジック。
- **検証 DF-018-10**: 順序混在テストを追加。
- **フォローアップ DF-018-11**: 監査ログに順序情報追記。

#### シナリオ DF-019: Directoryクエリのタイムアウト閾値逸脱
- **焦点 DF-019-01**: タイムアウト設定が不適切でコネクション失敗増を防ぐ。
- **フロー段階 DF-019-02**: Mix→Directory。
- **トリガ DF-019-03**: ネットワーク遅延増。
- **負荷条件 DF-019-04**: RTT平均180ms。
- **重要SLI DF-019-05**: 探索成功率≧97%。
- **可観測性 DF-019-06**: `directory.timeout_events`。
- **依存 DF-019-07**: `architecture/tech-stack.md`のSDK設定。
- **リスク DF-019-08**: セッション確立失敗連鎖。
- **推奨 DF-019-09**: 適応タイムアウト導入。
- **検証 DF-019-10**: RTTシナリオを変更しテスト。
- **フォローアップ DF-019-11**: 変更をRunbookに反映。

#### シナリオ DF-020: Telemetry落下時のフェイルセーフ
- **焦点 DF-020-01**: Telemetryが一時停止してもフローが安全に動作。
- **フロー段階 DF-020-02**: Monitoring→Control。
- **トリガ DF-020-03**: 観測基盤停止30秒。
- **負荷条件 DF-020-04**: Telemetry空白率100%。
- **重要SLI DF-020-05**: 過負荷検知失敗0件。
- **可観測性 DF-020-06**: フォールバックメトリクス利用状況ログ。
- **依存 DF-020-07**: `docs/architecture/overview.md`の変化戦略。
- **リスク DF-020-08**: 過負荷放置。
- **推奨 DF-020-09**: ローカル閾値と安全モードを導入。
- **検証 DF-020-10**: Telemetry停止演習。
- **フォローアップ DF-020-11**: 結果を`notes/decision-log.md`。

#### シナリオ DF-021: セッションハートビートの偏り
- **焦点 DF-021-01**: ハートビートが特定ノードへ集中しないか評価。
- **フロー段階 DF-021-02**: Stream→Mix継続監視。
- **トリガ DF-021-03**: 負荷分散設定変更。
- **負荷条件 DF-021-04**: 特定ノードへ40%集中。
- **重要SLI DF-021-05**: 偏り指数≦0.2。
- **可観測性 DF-021-06**: `stream.heartbeat_distribution`。
- **依存 DF-021-07**: `architecture/dependencies.md`のバランス規約。
- **リスク DF-021-08**: ノード過負荷。
- **推奨 DF-021-09**: ハートビート分散アルゴリズム調整。
- **検証 DF-021-10**: シミュレーションで集中度測定。
- **フォローアップ DF-021-11**: 改善案をRunbook化。

#### シナリオ DF-022: Stream再キーイングフローの遅延
- **焦点 DF-022-01**: セッション再キーイング中の通過データ遅延。
- **フロー段階 DF-022-02**: Stream→Control→Mix。
- **トリガ DF-022-03**: 鍵ローテーションウィンドウ。
- **負荷条件 DF-022-04**: 同時再キーイング5万。
- **重要SLI DF-022-05**: 再キー遅延≦250ms。
- **可観測性 DF-022-06**: `stream.rekey_latency`。
- **依存 DF-022-07**: `security/encryption.md`の手順遵守。
- **リスク DF-022-08**: データ停止でSLA違反。
- **推奨 DF-022-09**: ローテーションを波状にずらす。
- **検証 DF-022-10**: カナリア検証。
- **フォローアップ DF-022-11**: 結果を`notes/meeting-notes.md`。

#### シナリオ DF-023: Stream→Mixへのフレームドロップ検知遅延
- **焦点 DF-023-01**: ドロップ検知が遅れて再送嵐になるリスク。
- **フロー段階 DF-023-02**: Stream→Mix送信。
- **トリガ DF-023-03**: Mixバッファ一時枯渇。
- **負荷条件 DF-023-04**: ドロップ率5%。
- **重要SLI DF-023-05**: 検知遅延≦40ms。
- **可観測性 DF-023-06**: `mix.frame_drop_detect_latency`。
- **依存 DF-023-07**: `architecture/interfaces.md`のACK仕様。
- **リスク DF-023-08**: 再送増大。
- **推奨 DF-023-09**: 迅速なNACK通知と抑制。
- **検証 DF-023-10**: ドロップ注入テスト。
- **フォローアップ DF-023-11**: 指標を`performance/scalability.md`追加。

#### シナリオ DF-024: カバー交通の地理分散不足
- **焦点 DF-024-01**: カバー交通が特定リージョンに偏らないか評価。
- **フロー段階 DF-024-02**: Scheduler→Obfuscation→Transport。
- **トリガ DF-024-03**: 地理タグ設定ミス。
- **負荷条件 DF-024-04**: 80%が単一リージョン。
- **重要SLI DF-024-05**: 分散指数≧0.5。
- **可観測性 DF-024-06**: `obf.cover_geo_distribution`。
- **依存 DF-024-07**: `deployment/infrastructure.md`のリージョン設計。
- **リスク DF-024-08**: 匿名性弱化。
- **推奨 DF-024-09**: 地理ウェイト調整。
- **検証 DF-024-10**: 分散比率テスト。
- **フォローアップ DF-024-11**: 設定変更をRunbook反映。

#### シナリオ DF-025: Telemetryサンプリングレート過小
- **焦点 DF-025-01**: サンプリング低下でSLI精度が落ちないか確認。
- **フロー段階 DF-025-02**: Monitoringイベントループ。
- **トリガ DF-025-03**: コスト削減方針。
- **負荷条件 DF-025-04**: サンプリング1/10。
- **重要SLI DF-025-05**: 推定誤差≦±5%。
- **可観測性 DF-025-06**: `telemetry.sampling_error_rate`。
- **依存 DF-025-07**: `docs/specs.md`の指標要件。
- **リスク DF-025-08**: 異常検知遅延。
- **推奨 DF-025-09**: 重要指標だけ高サンプリング維持。
- **検証 DF-025-10**: 誤差分析。
- **フォローアップ DF-025-11**: ダッシュボードへ結果反映。

#### シナリオ DF-026: Compliance Exportのスローダウン
- **焦点 DF-026-01**: Analytics→Dashboard輸出が遅延しないか。
- **フロー段階 DF-026-02**: 監査ログストリーム。
- **トリガ DF-026-03**: ETLジョブ増加。
- **負荷条件 DF-026-04**: スループット50%低下。
- **重要SLI DF-026-05**: レポート遅延≦15分。
- **可観測性 DF-026-06**: `compliance.export_latency`。
- **依存 DF-026-07**: `docs/compliance_ci_integration.md`。
- **リスク DF-026-08**: 監査期限超過。
- **推奨 DF-026-09**: バッチ優先制御。
- **検証 DF-026-10**: ダッシュボードを使ったリハーサル。
- **フォローアップ DF-026-11**: 結果をRunbookへ。

#### シナリオ DF-027: Mixノードキー再配布
- **焦点 DF-027-01**: Mixノード鍵更新でフロー中断が発生しないか。
- **フロー段階 DF-027-02**: Stream→Mix鍵同期。
- **トリガ DF-027-03**: セキュリティローテーション。
- **負荷条件 DF-027-04**: 1時間で全ノード更新。
- **重要SLI DF-027-05**: 影響セッション率≦1%。
- **可観測性 DF-027-06**: `mix.key_rotation_events`。
- **依存 DF-027-07**: `security/encryption.md`のローテ規則。
- **リスク DF-027-08**: 中断による再接続嵐。
- **推奨 DF-027-09**: グレースフルなホットスワップ。
- **検証 DF-027-10**: カナリア更新。
- **フォローアップ DF-027-11**: レポート共有。

#### シナリオ DF-028: Stream Multiplexレーン切替
- **焦点 DF-028-01**: マルチプレックスレーン追加時のデータ亜重複。
- **フロー段階 DF-028-02**: Stream内部ルーティング。
- **トリガ DF-028-03**: 高優先度レーン追加。
- **負荷条件 DF-028-04**: レーン数2→5。
- **重要SLI DF-028-05**: 重複フレーム率≦0.1%。
- **可観測性 DF-028-06**: `stream.lane_duplicate_count`。
- **依存 DF-028-07**: `architecture/interfaces.md`のレーン契約。
- **リスク DF-028-08**: アプリ側で重複受信。
- **推奨 DF-028-09**: レーン識別子明示。
- **検証 DF-028-10**: Multiplex負荷テスト。
- **フォローアップ DF-028-11**: 結果を`performance/benchmark.md`に反映。

#### シナリオ DF-029: Transport経路変更の再順序化
- **焦点 DF-029-01**: 経路変更でパケット順序が乱れた際の補正。
- **フロー段階 DF-029-02**: Transport→Stream。
- **トリガ DF-029-03**: ルーティングテーブル更新。
- **負荷条件 DF-029-04**: 経路切替1分間に30回。
- **重要SLI DF-029-05**: 再順序化成功率≧99.9%。
- **可観測性 DF-029-06**: `transport.reordering_buffer_usage`。
- **依存 DF-029-07**: `architecture/dependencies.md`の順序契約。
- **リスク DF-029-08**: 再生停止。
- **推奨 DF-029-09**: バッファ閾値自動調整。
- **検証 DF-029-10**: 高頻度経路変更テスト。
- **フォローアップ DF-029-11**: Runbook更新。

#### シナリオ DF-030: Controlイベントの冗長化テスト
- **焦点 DF-030-01**: イベントバス冗長化がフローに影響しないか。
- **フロー段階 DF-030-02**: Control→各レイヤ。
- **トリガ DF-030-03**: 新冗長バス導入。
- **負荷条件 DF-030-04**: イベント重複率5%。
- **重要SLI DF-030-05**: 重複適用0件。
- **可観測性 DF-030-06**: `control.duplicate_event_detected`。
- **依存 DF-030-07**: `docs/configuration.md`の冪等実装。
- **リスク DF-030-08**: 設定不整合。
- **推奨 DF-030-09**: メッセージIDで重複排除。
- **検証 DF-030-10**: 冗長バス統合テスト。
- **フォローアップ DF-030-11**: 結果を`notes/decision-log.md`。

#### シナリオ DF-031: セッション統計出力の遅延
- **焦点 DF-031-01**: 日次統計生成が時間内に完了するか。
- **フロー段階 DF-031-02**: Telemetry→Analytics。
- **トリガ DF-031-03**: セッション数急増。
- **負荷条件 DF-031-04**: 日次データ1.5TB。
- **重要SLI DF-031-05**: 集計完了≦45分。
- **可観測性 DF-031-06**: `analytics.batch_duration`。
- **依存 DF-031-07**: `docs/specs.md`の報告要件。
- **リスク DF-031-08**: レポート遅延で意思決定遅れ。
- **推奨 DF-031-09**: バッチ並列化とカラムナDB活用。
- **検証 DF-031-10**: 負荷テストで計測。
- **フォローアップ DF-031-11**: 結果共有。

#### シナリオ DF-032: SDKバージョン混在時のデータフロー整合
- **焦点 DF-032-01**: 異なるSDKが混在してもフロー整合が壊れないか。
- **フロー段階 DF-032-02**: Client→Stream。
- **トリガ DF-032-03**: バックワード互換リリース。
- **負荷条件 DF-032-04**: 旧SDK30%、新SDK70%。
- **重要SLI DF-032-05**: 互換エラー率≦0.2%。
- **可観測性 DF-032-06**: `stream.sdk_version_mismatch`。
- **依存 DF-032-07**: `nyx-sdk/README.md`互換マトリクス。
- **リスク DF-032-08**: セッション切断。
- **推奨 DF-032-09**: 互換ビット設定を強制。
- **検証 DF-032-10**: Mixedバージョンテスト。
- **フォローアップ DF-032-11**: 結果を`docs/architecture/interfaces.md`へ。

#### シナリオ DF-033: Stream状態ストアのリージョン遅延
- **焦点 DF-033-01**: リージョン間コピー遅延でセッション復旧遅れないか。
- **フロー段階 DF-033-02**: Stream状態同期。
- **トリガ DF-033-03**: レイテンシ増大イベント。
- **負荷条件 DF-033-04**: レプリケーション遅延1.2秒。
- **重要SLI DF-033-05**: 復旧時間≦500ms。
- **可観測性 DF-033-06**: `stream.state_replication_lag`。
- **依存 DF-033-07**: `deployment/infrastructure.md`冗長戦略。
- **リスク DF-033-08**: フェイルオーバ失敗。
- **推奨 DF-033-09**: 差分同期と優先度制御。
- **検証 DF-033-10**: DR演習。
- **フォローアップ DF-033-11**: 結果をRunbookへ。

#### シナリオ DF-034: Multipathフロー同期ズレ
- **焦点 DF-034-01**: Multipath導入で各経路の到達差が大きくなる場合の整合。
- **フロー段階 DF-034-02**: Stream→Transport Multipath。
- **トリガ DF-034-03**: 経路遅延差200ms。
- **負荷条件 DF-034-04**: パス3本構成。
- **重要SLI DF-034-05**: 再順序化率≦0.3%。
- **可観測性 DF-034-06**: `transport.multipath_delay_gap`。
- **依存 DF-034-07**: `formal/nyx_multipath_plugin.cfg`指針。
- **リスク DF-034-08**: 遅延差でバッファ増。
- **推奨 DF-034-09**: パス重み調整と冗長パス抑制。
- **検証 DF-034-10**: Multipathベンチ。
- **フォローアップ DF-034-11**: 結果共有。

#### シナリオ DF-035: Streamフェイルオーバ時のダブル送信
- **焦点 DF-035-01**: フェイルオーバ切替で同一フレームが重複送信されないか。
- **フロー段階 DF-035-02**: Stream→Transport切替。
- **トリガ DF-035-03**: プライマリ切断。
- **負荷条件 DF-035-04**: 切替同時発生1000件。
- **重要SLI DF-035-05**: 重複率≦0.05%。
- **可観測性 DF-035-06**: `stream.failover_duplicate_frames`。
- **依存 DF-035-07**: `architecture/interfaces.md`のセッション識別子。
- **リスク DF-035-08**: 冗長データで帯域浪費。
- **推奨 DF-035-09**: フェイルオーバ時のACK調整。
- **検証 DF-035-10**: DRテストシナリオ。
- **フォローアップ DF-035-11**: Runbook追記。

#### シナリオ DF-036: Obfuscationダッシュボード更新遅延
- **焦点 DF-036-01**: カバー交通ダッシュボードの更新が遅延しないか。
- **フロー段階 DF-036-02**: Analytics→Dashboard。
- **トリガ DF-036-03**: クエリ負荷増。
- **負荷条件 DF-036-04**: 更新遅延60秒。
- **重要SLI DF-036-05**: ダッシュボード遅延≦10秒。
- **可観測性 DF-036-06**: `dashboard.refresh_latency`。
- **依存 DF-036-07**: `grafana/`設定。
- **リスク DF-036-08**: 運用判断遅れ。
- **推奨 DF-036-09**: キャッシュ層導入。
- **検証 DF-036-10**: クエリ最適化検証。
- **フォローアップ DF-036-11**: 結果共有。

#### シナリオ DF-037: Stream優先度調整イベントの競合
- **焦点 DF-037-01**: 複数優先度変更が競合時の整合性。
- **フロー段階 DF-037-02**: Control→Stream優先度設定。
- **トリガ DF-037-03**: 複数チーム同時更新。
- **負荷条件 DF-037-04**: 競合率15%。
- **重要SLI DF-037-05**: 行列整合性違反0件。
- **可観測性 DF-037-06**: `stream.priority_conflict`。
- **依存 DF-037-07**: `docs/configuration.md`ロック戦略。
- **リスク DF-037-08**: QoS崩壊。
- **推奨 DF-037-09**: 競合解消ルール定義。
- **検証 DF-037-10**: コンカレンシテスト。
- **フォローアップ DF-037-11**: 手順更新。

#### シナリオ DF-038: セッション統計レポートのパーシャル出力
- **焦点 DF-038-01**: 部分失敗で統計が欠損しないか。
- **フロー段階 DF-038-02**: Analytics出力。
- **トリガ DF-038-03**: ETL途中失敗。
- **負荷条件 DF-038-04**: 失敗率2%。
- **重要SLI DF-038-05**: 欠損率≦0.1%。
- **可観測性 DF-038-06**: `analytics.partial_export_rate`。
- **依存 DF-038-07**: `docs/specs.md`報告仕様。
- **リスク DF-038-08**: 判断ミス。
- **推奨 DF-038-09**: 自動再処理キュー。
- **検証 DF-038-10**: 失敗注入テスト。
- **フォローアップ DF-038-11**: 記録をRunbookへ。

#### シナリオ DF-039: Streamログフィルタリングの過剰適用
- **焦点 DF-039-01**: ログフィルタで重要イベントが除外されないか。
- **フロー段階 DF-039-02**: Stream→Telemetryログ。
- **トリガ DF-039-03**: 負荷軽減のログ抑制。
- **負荷条件 DF-039-04**: ログ削減率70%。
- **重要SLI DF-039-05**: 重要イベント欠落0件。
- **可観測性 DF-039-06**: `stream.log_sampling_gap`。
- **依存 DF-039-07**: `security/auth.md`監査要件。
- **リスク DF-039-08**: 障害解決困難。
- **推奨 DF-039-09**: 重要タグ優先記録。
- **検証 DF-039-10**: 障害再現でログ確認。
- **フォローアップ DF-039-11**: ガイドライン更新。

#### シナリオ DF-040: ControlイベントStormによる遅延
- **焦点 DF-040-01**: 同時多数設定変更で遅延が発生しないか。
- **フロー段階 DF-040-02**: Control Bus。
- **トリガ DF-040-03**: 大規模リコンフィグ。
- **負荷条件 DF-040-04**: 毎秒500イベント。
- **重要SLI DF-040-05**: 配信遅延≦5秒。
- **可観測性 DF-040-06**: `control.event_queue_depth`。
- **依存 DF-040-07**: `docs/compliance_ci_integration.md`変更手順。
- **リスク DF-040-08**: 設定反映遅延。
- **推奨 DF-040-09**: レート制御と優先度付け。
- **検証 DF-040-10**: イベントStorm演習。
- **フォローアップ DF-040-11**: レポート作成。

#### シナリオ DF-041: Streamメタデータ肥大化
- **焦点 DF-041-01**: メタデータ増でフレームサイズが閾値超過しないか。
- **フロー段階 DF-041-02**: Stream→Mix。
- **トリガ DF-041-03**: 新属性追加。
- **負荷条件 DF-041-04**: メタデータ30%増。
- **重要SLI DF-041-05**: フレームサイズ≦1150B。
- **可観測性 DF-041-06**: `stream.metadata_size`。
- **依存 DF-041-07**: `architecture/interfaces.md`仕様。
- **リスク DF-041-08**: MTU超過。
- **推奨 DF-041-09**: 圧縮と選別。
- **検証 DF-041-10**: サイズ検証テスト。
- **フォローアップ DF-041-11**: 結果共有。

#### シナリオ DF-042: Multipath統計の可観測性欠損
- **焦点 DF-042-01**: Multipath各パス統計が欠落しないか。
- **フロー段階 DF-042-02**: Transport Telemetry。
- **トリガ DF-042-03**: 新パス追加時の計測漏れ。
- **負荷条件 DF-042-04**: 欠測率10%。
- **重要SLI DF-042-05**: 完全計測率≧99%。
- **可観測性 DF-042-06**: `transport.path_metric_coverage`。
- **依存 DF-042-07**: `telemetry`設定。
- **リスク DF-042-08**: パス異常未検知。
- **推奨 DF-042-09**: 自動メトリクス登録。
- **検証 DF-042-10**: パス追加テスト。
- **フォローアップ DF-042-11**: Runbook更新。

#### シナリオ DF-043: Stream障害検知とAudit連携遅延
- **焦点 DF-043-01**: 障害発生から監査ログ生成までの遅延。
- **フロー段階 DF-043-02**: Stream→Audit Bus。
- **トリガ DF-043-03**: 障害通知遅延。
- **負荷条件 DF-043-04**: 連鎖障害10件。
- **重要SLI DF-043-05**: 監査記録遅延≦60秒。
- **可観測性 DF-043-06**: `audit.incident_capture_latency`。
- **依存 DF-043-07**: `security/vulnerability.md`。
- **リスク DF-043-08**: 監査不備。
- **推奨 DF-043-09**: 障害イベント優先キュー。
- **検証 DF-043-10**: 障害再現テスト。
- **フォローアップ DF-043-11**: 記録。

#### シナリオ DF-044: Control→Telemetryフィードバックループ安定性
- **焦点 DF-044-01**: 制御ループが振動しないか。
- **フロー段階 DF-044-02**: Control調整→Telemetry評価。
- **トリガ DF-044-03**: 過補償設定。
- **負荷条件 DF-044-04**: 調整周期1秒。
- **重要SLI DF-044-05**: 指標振幅≦±5%。
- **可観測性 DF-044-06**: `control.feedback_oscillation`。
- **依存 DF-044-07**: `performance/benchmark.md`。
- **リスク DF-044-08**: 不安定化。
- **推奨 DF-044-09**: PIDゲイン調整。
- **検証 DF-044-10**: ループチューニング。
- **フォローアップ DF-044-11**: 調整記録。

#### シナリオ DF-045: セッション断片再構成の統計確認
- **焦点 DF-045-01**: 断片化パケット再構成が正確か検証。
- **フロー段階 DF-045-02**: Transport→Stream。
- **トリガ DF-045-03**: パケット損失高。
- **負荷条件 DF-045-04**: 再構成要求率12%。
- **重要SLI DF-045-05**: 再構成失敗率≦0.3%。
- **可観測性 DF-045-06**: `stream.fragment_reassembly_error`。
- **依存 DF-045-07**: `architecture/interfaces.md`。
- **リスク DF-045-08**: データ破損。
- **推奨 DF-045-09**: 断片検証を強化。
- **検証 DF-045-10**: 再構成テスト。
- **フォローアップ DF-045-11**: 結果共有。

#### シナリオ DF-046: ハートビートとデータフレームの競合
- **焦点 DF-046-01**: ハートビートがデータフレームを圧迫しないか。
- **フロー段階 DF-046-02**: Stream送信キュー。
- **トリガ DF-046-03**: ハートビート頻度増。
- **負荷条件 DF-046-04**: ハートビート比率40%。
- **重要SLI DF-046-05**: データ遅延増≦5%。
- **可観測性 DF-046-06**: `stream.heartbeat_queue_share`。
- **依存 DF-046-07**: `architecture/dependencies.md`。
- **リスク DF-046-08**: 重要データ遅延。
- **推奨 DF-046-09**: Separateキュー導入。
- **検証 DF-046-10**: ハートビート調整テスト。
- **フォローアップ DF-046-11**: Runbook追記。

#### シナリオ DF-047: Streamガベージコレクションのフロー影響
- **焦点 DF-047-01**: GCがフレーム処理を阻害しないか。
- **フロー段階 DF-047-02**: Stream内部。
- **トリガ DF-047-03**: GC頻度増。
- **負荷条件 DF-047-04**: GC停止時間30ms。
- **重要SLI DF-047-05**: スループット低下≦3%。
- **可観測性 DF-047-06**: `stream.gc_pause_duration`。
- **依存 DF-047-07**: 言語ランタイム設定。
- **リスク DF-047-08**: レイテンシ増。
- **推奨 DF-047-09**: GCチューニング。
- **検証 DF-047-10**: プロファイリング。
- **フォローアップ DF-047-11**: 調整記録。

#### シナリオ DF-048: データフロー暗号タグの欠落
- **焦点 DF-048-01**: 暗号タグ欠落で復号失敗しないか。
- **フロー段階 DF-048-02**: Stream→Mix→Obfuscation。
- **トリガ DF-048-03**: SDKバグ。
- **負荷条件 DF-048-04**: タグ欠落率0.2%。
- **重要SLI DF-048-05**: 復号失敗≦0.01%。
- **可観測性 DF-048-06**: `obf.missing_auth_tags`。
- **依存 DF-048-07**: `security/encryption.md`。
- **リスク DF-048-08**: フロー停止。
- **推奨 DF-048-09**: SDK検証強化。
- **検証 DF-048-10**: 負荷テスト。
- **フォローアップ DF-048-11**: バグ修正追跡。

#### シナリオ DF-049: Streamセッションメタストアの肥大対策
- **焦点 DF-049-01**: メタストア肥大でフロー遅延しないか。
- **フロー段階 DF-049-02**: Control→Stream状態管理。
- **トリガ DF-049-03**: セッション属性増。
- **負荷条件 DF-049-04**: 1セッション当たりメタ1KB→3KB。
- **重要SLI DF-049-05**: 状態取得レイテンシ≦5ms。
- **可観測性 DF-049-06**: `stream.state_lookup_latency`。
- **依存 DF-049-07**: `docs/configuration.md`。
- **リスク DF-049-08**: 状態取得遅延。
- **推奨 DF-049-09**: TTL調整と圧縮。
- **検証 DF-049-10**: 状態負荷テスト。
- **フォローアップ DF-049-11**: 記録。

#### シナリオ DF-050: フロー全体の終端到達率モニタリング
- **焦点 DF-050-01**: Client→Clientまでのエンドツーエンド到達率を継続監視。
- **フロー段階 DF-050-02**: 全体パス。
- **トリガ DF-050-03**: SLA報告要求。
- **負荷条件 DF-050-04**: 1日あたり1億経路。
- **重要SLI DF-050-05**: 到達率≧99.95%。
- **可観測性 DF-050-06**: `end_to_end.success_ratio`ダッシュボード。
- **依存 DF-050-07**: すべての中間レイヤメトリクス連携。
- **リスク DF-050-08**: 不可視部分での障害。
- **推奨 DF-050-09**: 統合トレースで経路確認。
- **検証 DF-050-10**: 定期SLO監査。
- **フォローアップ DF-050-11**: 結果を`docs/specs.md`報告章に反映。

## 関連ドキュメント
- [architecture/overview.md](./overview.md)
- [architecture/interfaces.md](./interfaces.md)
- [performance/benchmark.md](../performance/benchmark.md)
- [security/vulnerability.md](../security/vulnerability.md)
- [testing/e2e-tests.md](../testing/e2e-tests.md)

> **宣言**: 本章は実装コード、C/C++依存を含まない。