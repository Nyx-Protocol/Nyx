# NyxNet 技術仕様書
*U22プログラミングコンテスト 提出用*

## 1. システム概要

### 1.1 プロジェクト名
NyxNet - Modular Privacy-First Networking Stack

### 1.2 開発目的
- プライバシー保護を重視したネットワーク通信の実現
- モジュラー設計による拡張性・保守性の確保
- 現代的な暗号技術の実装とセキュリティ強化

### 1.3 主要機能
- 暗号化通信デーモン
- コマンドライン管理インターフェース
- モバイル・Web統合SDK
- プラグインシステム

## 2. 技術アーキテクチャ

### 2.1 言語・フレームワーク
- **メイン言語**: Rust 2021 Edition
- **非同期ランタイム**: Tokio 1.37
- **シリアライゼーション**: Serde
- **暗号ライブラリ**: 自家製（unsafe code禁止）

### 2.2 モジュール構成

#### コア層
- `nyx-core`: 基本機能（ID生成、時刻、設定、国際化）
- `nyx-crypto`: 暗号プリミティブ（AEAD、KDF、HPKE）
- `nyx-transport`: 低レベルネットワーク（UDP/TCP）

#### 機能層
- `nyx-stream`: ストリーム処理・プラグインフレームワーク
- `nyx-fec`: 前方誤り訂正（1280バイト固定シャード）
- `nyx-mix`: ミックスネット機能
- `nyx-telemetry`: メトリクス・監視（Prometheus）

#### アプリケーション層
- `nyx-daemon`: メインデーモンプロセス
- `nyx-cli`: 管理CLI
- `nyx-control`: 制御API

#### SDK層
- `nyx-sdk`: Rust アプリケーション用SDK
- `nyx-sdk-wasm`: WebAssembly/ブラウザ用
- `nyx-mobile-ffi`: モバイルアプリ用C-ABI

#### ツール層
- `nyx-conformance`: テスト・検証ツール
- `build-protoc`: ビルド支援

### 2.3 プロトコル仕様

#### Nyx Protocol v1.0
- **フレーム形式**: 固定1280バイト
- **暗号化**: X25519 + Kyber (Post-Quantum)
- **認証**: HPKE (Hybrid Public Key Encryption)
- **多経路**: パケット単位のPathID
- **プラグイン**: CBOR形式ヘッダー (0x50-0x5F)

#### セキュリティ機能
- リプレイ攻撃防止ウィンドウ (2^20)
- 前方秘匿性
- 能力ネゴシエーション
- アダプティブカバートラフィック

## 3. 実装詳細

### 3.1 コーディング規約
```rust
// Workspace全体で統一された規約
#[warn(missing_docs)]
#[forbid(unsafe_code)]
#[warn(clippy::unwrap_used)]
```

### 3.2 主要構造体

#### デーモン設定
```rust
#[derive(Serialize, Deserialize)]
pub struct Config {
    pub log_level: String,
    pub listen_port: u16,
    pub network: NetworkConfig,
    pub max_frame_len_bytes: u32,
}
```

#### ストリーム管理
```rust
pub struct StreamManager {
    plugins: PluginRegistry,
    connections: ConnectionPool,
    metrics: MetricsCollector,
}
```

### 3.3 プラグインシステム
- 動的ロード対応
- 権限管理システム
- CBOR形式のメタデータ

### 3.4 IPC通信
- **Unix**: Unix Domain Socket (`/tmp/nyx.sock`)
- **Windows**: Named Pipe (`\\.\pipe\nyx-daemon`)
- **形式**: 改行区切りJSON-RPC

主要エンドポイント:
- `get_info`: システム情報取得
- `reload_config`: 設定再読み込み
- `subscribe_events`: イベントストリーム

## 4. セキュリティ設計

### 4.1 認証システム
- トークンベース認証
- 環境変数優先順位: `NYX_DAEMON_TOKEN` → クッキーファイル
- 厳密認証モード (`NYX_DAEMON_STRICT_AUTH=1`)

### 4.2 暗号技術
- **鍵交換**: X25519 (楕円曲線) + Kyber (格子暗号)
- **対称暗号**: AES-256-GCM
- **ハッシュ**: SHA-256, BLAKE3
- **KDF**: HKDF-SHA256

### 4.3 メモリ安全性
- Rust言語特性による自動メモリ管理
- unsafe codeの完全禁止
- 境界検査・型安全性

## 5. パフォーマンス最適化

### 5.1 並行処理
- Tokio非同期ランタイム
- ワーカープール設計
- ノンブロッキングI/O

### 5.2 メトリクス
- Prometheus形式メトリクス
- OpenTelemetry対応トレーシング
- パフォーマンス監視

### 5.3 リソース管理
- 接続プール
- メモリ使用量制限
- 適応的レート制限

## 6. 品質保証

### 6.1 テスト戦略
- 単体テスト（各クレート）
- 統合テスト（E2E）
- 性能テスト（ベンチマーク）
- セキュリティテスト

### 6.2 静的解析
- Clippy (Rustのlinter)
- 依存関係監査 (`cargo audit`)
- コードカバレッジ測定

### 6.3 形式検証
- TLA+モデル（`formal/`ディレクトリ）
- プロパティベースドテスト
- 並行性検証

## 7. 配置・運用

### 7.1 コンテナ対応
- Dockerイメージ
- Kubernetes Helmチャート
- セキュリティコンテキスト（seccomp）

### 7.2 監視・ログ
- 構造化ログ（JSON）
- 分散トレーシング
- アラート機能

### 7.3 設定管理
- 動的設定リロード
- 設定バージョン管理
- ロールバック機能

## 8. 開発プロセス

### 8.1 バージョン管理
- Git（SeleniaProject/Nyx）
- セマンティックバージョニング
- CHANGELOG.md管理

### 8.2 継続的インテグレーション
- 自動テスト実行
- セキュリティスキャン
- 依存関係更新チェック

### 8.3 ドキュメント
- コード内ドキュメント（rustdoc）
- 技術仕様書（Markdown）
- API文書自動生成

## 9. 今後の展開

### 9.1 計画中機能
- モバイルアプリSDK完成
- Webブラウザ統合強化
- 分散ネットワーク機能

### 9.2 パフォーマンス改善
- SIMD最適化
- ゼロコピー実装
- キャッシュ効率化

### 9.3 セキュリティ強化
- 耐量子暗号の追加実装
- フォーマル検証範囲拡大
- セキュリティ監査

---

## 付録: ビルド・実行環境

### 必要ツール
- Rust 1.75+ (rust-toolchain.toml指定)
- Cargo (Rustパッケージマネージャー)

### ビルドコマンド
```bash
cargo build --release
```

### 実行環境
- Windows 10/11 (64-bit)
- Linux (glibc 2.31+)
- macOS 11.0+

本技術仕様書は、NyxNetの設計思想と実装詳細を包括的に記述しています。
